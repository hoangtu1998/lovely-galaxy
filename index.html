<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>üíñ M·ªü Qu√† B√≠ M·∫≠t üíñ</title>

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Quicksand:wght@600&family=Bubblegum+Sans&display=swap" rel="stylesheet">

  <meta name="theme-color" content="#000000">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    :root{
      /* t√¥ng galaxy: t√≠m xanh + neon */
      --ink:#e8ebff;
      --muted:#8b8fc0;
      --key-bg:rgba(19, 29, 75, 0.75);
      --key-bg-active:rgba(93, 159, 255, 0.9);
      --accent:#ffffff;
      --glow:0 0 12px rgba(124, 197, 255, 0.9);
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; }

    body{
      min-height:100vh;
      margin:0;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      padding:0 16px;
      color:var(--ink);
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Quicksand",sans-serif;
      background:
        radial-gradient(circle at 15% 0%, #4b2cff 0%, transparent 55%),
        radial-gradient(circle at 85% 0%, #ff5fdc 0%, transparent 60%),
        radial-gradient(circle at 50% 100%, #0a2342 0%, #02020a 55%, #000000 100%);
      background-attachment:fixed;
    }

    /* gi·∫£ Dynamic Island */
    .top-bar{
      width:100%;
      max-width:430px;
      padding-top:18px;
      display:flex;
      justify-content:center;
    }
    .island{
      width:150px;
      height:32px;
      border-radius:999px;
      background:rgba(0,0,0,0.88);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 10px;
      color:#ffffff;
      font-size:14px;
      box-shadow:0 0 18px rgba(0,0,0,0.8);
    }
    .island-lock{
      font-size:15px;
    }
    .island-dot{
      width:14px;
      height:14px;
      border-radius:50%;
      border:2px solid rgba(255,255,255,0.55);
      box-shadow:0 0 0 2px rgba(0,0,0,0.9);
    }

    h1{
      margin-top:48px;
      margin-bottom:18px;
      font-size:22px;
      font-weight:500;
      text-align:center;
      text-shadow:0 0 10px rgba(165, 191, 255, 0.7);
    }

    .wrap{
      width:100%;
      max-width:430px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:24px;
    }

    .card{
      width:100%;
      background:transparent;
      border:none;
      box-shadow:none;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:24px;
      transition:transform .15s ease;
    }

    /* ·∫©n ph·∫ßn ·∫£nh nh∆∞ng v·∫´n gi·ªØ ƒë·ªÉ code d√πng */
    .left{ display:none; }

    /* v√πng ch·∫•m m·∫≠t m√£ */
    .display{
      min-width:0;
      background:transparent;
      border:none;
      box-shadow:none;
      display:flex;
      justify-content:center;
      gap:14px;
      padding:0;
    }
    .dot{
      width:12px;
      height:12px;
      border-radius:50%;
      border:2px solid rgba(198, 211, 255, 0.9);
      background:transparent;
      transition:background .15s ease,border-color .15s ease, box-shadow .15s ease;
    }
    .dot.filled{
      background:var(--accent);
      border-color:var(--accent);
      box-shadow:0 0 10px rgba(124, 197, 255, 0.9);
    }

    .right{
      width:100%;
      max-width:360px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:24px;
    }

    .pad{
      width:100%;
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:16px;
      user-select:none;
    }

    button.key{
      position:relative;
      width:100%;
      aspect-ratio:1/1;
      border-radius:999px;
      border:none;
      background:var(--key-bg);
      backdrop-filter:blur(18px);
      -webkit-backdrop-filter:blur(18px);
      box-shadow:0 4px 18px rgba(0,0,0,0.85);
      color:var(--accent);
      cursor:pointer;
      transition:transform .08s ease, background .12s ease, box-shadow .12s ease;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
    }
    button.key:active{
      transform:scale(.94);
      background:var(--key-bg-active);
      box-shadow:var(--glow);
    }

    .num{
      font-size:30px;
      font-weight:500;
      line-height:1;
      text-shadow:0 0 8px rgba(160, 210, 255, 0.9);
    }
    .letters{
      margin-top:2px;
      font-size:11px;
      letter-spacing:1px;
      text-transform:uppercase;
      color:var(--muted);
    }

    .key.del{
      font-size:18px;
      text-shadow:none;
    }

    .foot{
      width:100%;
      max-width:360px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:14px;
      color:var(--muted);
      margin-top:8px;
    }
    .foot a{
      color:var(--muted);
      text-decoration:none;
    }
    .foot a:hover{ text-decoration:underline; }

    .links{
      margin-top:10px;
      font-size:13px;
      color:var(--muted);
    }
    .links a{
      color:#8bd1ff;
      text-decoration:none;
    }
    .links a:hover{ text-decoration:underline; }

    @media (max-width:480px){
      h1{ margin-top:40px; }
    }
  </style>
</head>
<body>
  <!-- Dynamic Island -->
  <div class="top-bar">
    <div class="island">
      <span class="island-lock">üîí</span>
      <span class="island-dot"></span>
    </div>
  </div>

  <h1>Nh·∫≠p m·∫≠t m√£</h1>

  <section class="wrap">
    <div class="card" id="card">
      <!-- ·∫¢nh index d√πng cho IndexedDB (·∫©n b·∫±ng CSS) -->
      <div class="left">
        <div class="frame">
          <img id="indexPic" src="assets/OIP.webp" alt="·∫¢nh index"/>
        </div>
      </div>

      <div class="right">
        <!-- 6 ch·∫•m m·∫≠t m√£ -->
        <div class="display" id="disp">
          <div class="dot" data-i="0"></div>
          <div class="dot" data-i="1"></div>
          <div class="dot" data-i="2"></div>
          <div class="dot" data-i="3"></div>
          <div class="dot" data-i="4"></div>
          <div class="dot" data-i="5"></div>
        </div>

        <!-- B√†n ph√≠m s·ªë -->
        <div class="pad">
          <button class="key" data-k="1">
            <span class="num">1</span>
          </button>
          <button class="key" data-k="2">
            <span class="num">2</span>
            <span class="letters">ABC</span>
          </button>
          <button class="key" data-k="3">
            <span class="num">3</span>
            <span class="letters">DEF</span>
          </button>

          <button class="key" data-k="4">
            <span class="num">4</span>
            <span class="letters">GHI</span>
          </button>
          <button class="key" data-k="5">
            <span class="num">5</span>
            <span class="letters">JKL</span>
          </button>
          <button class="key" data-k="6">
            <span class="num">6</span>
            <span class="letters">MNO</span>
          </button>

          <button class="key" data-k="7">
            <span class="num">7</span>
            <span class="letters">PQRS</span>
          </button>
          <button class="key" data-k="8">
            <span class="num">8</span>
            <span class="letters">TUV</span>
          </button>
          <button class="key" data-k="9">
            <span class="num">9</span>
            <span class="letters">WXYZ</span>
          </button>

          <div></div>
          <button class="key" data-k="0">
            <span class="num">0</span>
          </button>
          <button class="key del" data-k="del">‚å´</button>
        </div>

        <div class="foot">
          <span>Kh·∫©n c·∫•p</span>
          <a href="settings.html">H·ªßy</a>
        </div>
      </div>
    </div>

    <div class="links">
      <a href="settings.html">‚öôÔ∏è C√†i ƒë·∫∑t ·∫£nh & m·∫≠t kh·∫©u</a>
    </div>
  </section>

<script>
/* ==== m·∫≠t kh·∫©u d√πng localStorage nh∆∞ c≈© ==== */
const LS_PW = 'userPassword';

const disp = document.getElementById('disp');
const card = document.getElementById('card');
let buf = "";
const MAX_LEN = 6; // t·ªëi ƒëa 6 s·ªë gi·ªëng iPhone

/* l·∫•y m·∫≠t kh·∫©u ƒëang l∆∞u */
function getSecret(){
  return (localStorage.getItem(LS_PW)||'').trim() || "1234";
}

/* c·∫≠p nh·∫≠t ch·∫•m tr√≤n */
function updateDisp(){
  const dots = disp.querySelectorAll('.dot');
  dots.forEach((d,i)=>{
    if(i < buf.length) d.classList.add('filled');
    else d.classList.remove('filled');
  });
}

/* hi·ªáu ·ª©ng l·∫Øc khi sai pass */
function shake(){
  card.style.transition='transform .08s';
  card.style.transform='translateX(-5px)';
  setTimeout(()=> card.style.transform='translateX(5px)',70);
  setTimeout(()=> card.style.transform='translateX(0)',140);
}

function submit(){
  if(buf===getSecret()){
    localStorage.setItem('gift_unlocked','1');
    // Cho ph√©p autoplay nh·∫°c ·ªü trang birthday
    sessionStorage.setItem('allow_music','1');
    location.href='birthday.html';
  }else{
    buf=""; updateDisp(); shake();
  }
}

/* x·ª≠ l√Ω b·∫•m ph√≠m */
function press(k){
  if(k==='del'){
    buf = buf.slice(0,-1);
    return updateDisp();
  }
  if(/^[0-9]$/.test(k) && buf.length < MAX_LEN){
    buf += k;
    updateDisp();

    const secretLen = getSecret().length;
    // Khi nh·∫≠p ƒë·ªß s·ªë b·∫±ng ƒë·ªô d√†i m·∫≠t kh·∫©u -> t·ª± submit
    if(buf.length === secretLen){
      submit();
    }
  }
}

/* click keypad */
document.querySelectorAll('.key').forEach(b=>{
  b.addEventListener('click',()=>press(b.dataset.k));
});

/* b√†n ph√≠m th·∫≠t (d√πng tr√™n PC) */
addEventListener('keydown',e=>{
  if(e.key>='0'&&e.key<='9') press(e.key);
  if(e.key==='Backspace')    press('del');
  if(e.key==='Enter')        submit();
});

/* render ban ƒë·∫ßu */
updateDisp();

/* ==== L·∫•y ·∫£nh Index t·ª´ IndexedDB (gi·ªØ nguy√™n logic) ==== */
const DB_NAME = 'birthdayDB';
const DB_VER  = 1;
const STORE   = 'images';
const INDEX_KEY = 'img_index_main';

function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = () => {
      const db = req.result;
      if (!db.objectStoreNames.contains(STORE)) {
        db.createObjectStore(STORE);
      }
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror   = () => reject(req.error);
  });
}

async function getImageFromDB(key){
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE,'readonly');
    const req = tx.objectStore(STORE).get(key);
    req.onsuccess = () => resolve(req.result || null);
    req.onerror   = () => reject(req.error);
  });
}

/* load ·∫£nh Index khi m·ªü trang */
(async function loadIndexPic(){
  const imgEl = document.getElementById('indexPic');
  try {
    const blob = await getImageFromDB(INDEX_KEY);
    if (blob) {
      const url = URL.createObjectURL(blob);
      imgEl.src = url;
    } else {
      imgEl.src = "assets/OIP.webp";
    }
  } catch (err) {
    console.error('Kh√¥ng load ƒë∆∞·ª£c ·∫£nh Index t·ª´ IndexedDB:', err);
    imgEl.src = "assets/OIP.webp";
  }
})();

/* ==== PWA service worker ==== */
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('./sw.js').catch(()=>{});
}
</script>
</body>
</html>
