<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>C√†i ƒë·∫∑t ·∫£nh & m·∫≠t kh·∫©u</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0e14; --card:#121826; --muted:#8a93a6; --ink:#e6ebff; --accent:#6ee7ff;
      --box:#0f1422; --ok:#62f3a2; --warn:#ff7a7a; --border:#1e2637;
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; background:radial-gradient(1200px 700px at 80% 10%, #141d2f, #0b0e14 60%);
      color:var(--ink); font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    h1{ text-align:center; font-size:clamp(22px,3vw,28px); margin:16px 0 6px }
    p.sub{ text-align:center; color:var(--muted); margin:0 0 18px }
    .wrap{ width:min(1100px, 94vw); margin:0 auto 40px; display:grid; gap:18px }

    /* GRID ·∫¢NH CH√çNH */
    .grid-main{ display:grid; grid-template-columns: repeat(4,1fr); gap:16px; }

    /* GRID GALAXY */
    .grid-galaxy{ display:grid; grid-template-columns: repeat(auto-fit,minmax(160px,1fr)); gap:16px; }

    .card{
      background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .title{ font-weight:700; margin:0 0 10px; letter-spacing:.2px; font-size:14px; line-height:1.4; color:#fff }
    .preview{
      width:100%; aspect-ratio:1/1; background:var(--box); border:1px dashed #2b3550;
      border-radius:12px; display:grid; place-items:center; overflow:hidden; margin-bottom:10px;
      font-size:12px; color:var(--muted); text-align:center; padding:8px;
    }
    .preview img{ width:100%; height:100%; object-fit:cover }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .row input[type="file"]{ flex:1; color:var(--muted); font-size:12px }
    .row small{ color:var(--muted) }
    .pad{
      background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px;
    }

    label{ display:block; color:var(--muted); font-size:13px; margin:8px 0 6px }
    input[type="password"], input[type="text"]{
      width:100%; height:42px; background:var(--box); color:var(--ink); border:1px solid #2b3550;
      border-radius:10px; padding:0 12px; outline:none;
    }

    .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; align-items:center }
    button{
      height:40px; border-radius:10px; border:1px solid var(--border); background:#111829; color:#dfe6ff;
      padding:0 14px; cursor:pointer; font-size:14px;
    }
    button.primary{ background:linear-gradient(0deg,#0ea5e9,#38bdf8); border:0; color:#00121a; font-weight:700 }
    button.green{ background:linear-gradient(0deg,#34d399,#6ee7b7); border:0; color:#022b1e; font-weight:700 }
    button.red{ background:linear-gradient(0deg,#fb7185,#fda4af); border:0; color:#33050e; font-weight:700 }

    .hint{ color:var(--muted); font-size:12px; margin-top:6px; line-height:1.4 }
    .footer{ text-align:center; color:#8ea3c2; opacity:.85; margin-top:10px; font-size:12px }
    .ok{ color:var(--ok); font-size:13px }
    .warn{ color:var(--warn); font-size:13px }

    .noteGalaxy{
      font-size:12px;
      line-height:1.4;
      color:var(--muted);
      margin-top:6px;
    }

    @media (max-width:1100px){
      .grid-main{ grid-template-columns:repeat(2,1fr); }
    }
    @media (max-width:600px){
      .grid-main{ grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <h1>‚öôÔ∏è C√†i ƒë·∫∑t ·∫£nh & m·∫≠t kh·∫©u</h1>
  <p class="sub">
    Ch·ªçn ·∫£nh cho c√°c m√†n + t·ªëi ƒëa 5 ·∫£nh Galaxy quay xung quanh üíù<br/>
    (Galaxy d√πng b·ªô nh·ªõ l·ªõn h∆°n - l∆∞u b·∫±ng IndexedDB, kh√¥ng s·ª£ full localStorage)
  </p>

  <section class="wrap">

    <!-- ·∫¢NH CH√çNH -->
    <div class="grid-main">

      <!-- INDEX -->
      <div class="card">
        <div class="title">·∫¢nh cho <u>Index</u> (m√†n h√¨nh nh·∫≠p pass)</div>
        <div class="preview" id="pv_index"><small>Ch∆∞a c√≥ ·∫£nh</small></div>
        <div class="row">
          <input type="file" id="f_index" accept="image/*">
        </div>
        <small class="hint">Hi·ªÉn th·ªã b√™n tr√°i m√†n h√¨nh nh·∫≠p m·∫≠t kh·∫©u.</small>
      </div>

      <!-- BIRTHDAY - TOP -->
      <div class="card">
        <div class="title">·∫¢nh cho <u>Birthday ‚Äî Top</u> (·∫£nh n·ªÅn trang ch√∫c m·ª´ng)</div>
        <div class="preview" id="pv_birthday_top"><small>M·∫∑c ƒë·ªãnh: <code>assets/cute-cake.png</code></small></div>
        <div class="row">
          <input type="file" id="f_birthday_top" accept="image/*">
        </div>
        <small class="hint">
          N·∫øu kh√¥ng ch·ªçn, d√πng <b>assets/cute-cake.png</b>.
        </small>
      </div>

      <!-- BIRTHDAY - CARD -->
      <div class="card">
        <div class="title">·∫¢nh cho <u>Birthday ‚Äî Card</u> (thi·ªáp/h·ªôp qu√†)</div>
        <div class="preview" id="pv_birthday_card"><small>M·∫∑c ƒë·ªãnh: <code>assets/card-cute.jpg</code></small></div>
        <div class="row">
          <input type="file" id="f_birthday_card" accept="image/*">
        </div>
        <small class="hint">
          N·∫øu kh√¥ng ch·ªçn, d√πng <b>assets/card-cute.jpg</b>.
        </small>
      </div>

      <!-- L·ªúI CH√öC + PASS -->
      <div class="card">
        <div class="title">M·∫≠t kh·∫©u v√† l·ªùi ch√∫c</div>

        <label for="pw">M·∫≠t kh·∫©u m·ªü qu√†</label>
        <input type="password" id="pw" placeholder="V√≠ d·ª•: 1234">

        <label for="greeting">L·ªùi ch√∫c khi m·ªü qu√†</label>
        <input type="text" id="greeting" placeholder="V√≠ d·ª•: Ch√∫c b·∫°n tu·ªïi m·ªõi r·ª±c r·ª° & h·∫°nh ph√∫c! üíñ">

        <div class="noteGalaxy">
          L·ªùi ch√∫c s·∫Ω hi·ªán ·ªü m√†n Galaxy ‚ú®
        </div>
      </div>
    </div>

    <!-- GALAXY IMAGES -->
    <div class="card">
      <div class="title">
        ·∫¢nh cho <u>Galaxy</u> (t·ªëi ƒëa 5 ·∫£nh s·∫Ω quay trong kh√¥ng gian + ph√≥ng to spotlight)
      </div>

      <div class="grid-galaxy">

        <div>
          <div class="preview" id="pv_galaxy_1"><small>Galaxy #1<br>Ch∆∞a c√≥ ·∫£nh</small></div>
          <div class="row">
            <input type="file" id="f_galaxy_1" accept="image/*">
          </div>
        </div>

        <div>
          <div class="preview" id="pv_galaxy_2"><small>Galaxy #2<br>Ch∆∞a c√≥ ·∫£nh</small></div>
          <div class="row">
            <input type="file" id="f_galaxy_2" accept="image/*">
          </div>
        </div>

        <div>
          <div class="preview" id="pv_galaxy_3"><small>Galaxy #3<br>Ch∆∞a c√≥ ·∫£nh</small></div>
          <div class="row">
            <input type="file" id="f_galaxy_3" accept="image/*">
          </div>
        </div>

        <div>
          <div class="preview" id="pv_galaxy_4"><small>Galaxy #4<br>Ch∆∞a c√≥ ·∫£nh</small></div>
          <div class="row">
            <input type="file" id="f_galaxy_4" accept="image/*">
          </div>
        </div>

        <div>
          <div class="preview" id="pv_galaxy_5"><small>Galaxy #5<br>Ch∆∞a c√≥ ·∫£nh</small></div>
          <div class="row">
            <input type="file" id="f_galaxy_5" accept="image/*">
          </div>
        </div>

      </div>

      <div class="noteGalaxy">
        C√°c ·∫£nh Galaxy ƒë∆∞·ª£c l∆∞u b·∫±ng IndexedDB (b·ªô nh·ªõ ri√™ng l·ªõn h∆°n).<br/>
        JSON export b√™n d∆∞·ªõi KH√îNG mang theo m·∫•y ·∫£nh n√†y ‚Äî n·∫øu b·∫°n import ·ªü m√°y kh√°c th√¨ nh·ªõ up l·∫°i Galaxy nh√© üõ∞Ô∏è
      </div>
    </div>

    <!-- ACTIONS -->
    <div class="card">
      <div class="title">L∆∞u / Xu·∫•t / Nh·∫≠p</div>

      <div class="actions">
        <button class="primary" id="btnSave">üíæ L∆∞u</button>
        <button class="red" id="btnClear">üóë X√≥a h·∫øt</button>

        <button id="btnExport">‚¨áÔ∏è Export</button>
        <label for="imp" style="display:inline-block;">
          <button id="btnImport">‚¨ÜÔ∏è Import</button>
        </label>
        <input id="imp" type="file" accept="application/json" style="display:none">

        <span id="msg" style="margin-left:auto;"></span>
      </div>

      <div class="footer">
        ·∫¢nh Index / Birthday Top / Birthday Card v·∫´n l∆∞u b·∫±ng localStorage (base64).<br/>
        Galaxy d√πng IndexedDB n√™n ch·ª©a ƒë∆∞·ª£c ·∫£nh n·∫∑ng h∆°n nhi·ªÅu üíï
      </div>
    </div>

    <div style="text-align:center;margin-top:8px">
      <a href="index.html" style="color:#a7f3d0;text-decoration:none">‚Üê Quay l·∫°i Index</a>
    </div>

  </section>

<script>
/* =======================================================
   1. CONSTANT KEYS (gi·ªØ nh∆∞ tr∆∞·ªõc ƒë·ªÉ trang kh√°c ƒë·ªçc ƒë∆∞·ª£c)
   ======================================================= */
const LS_PW             = 'userPassword';
const LS_IMG_INDEX      = 'img_index_dataurl';
const LS_IMG_BIRTH_TOP  = 'img_birthday_top_dataurl';
const LS_IMG_BIRTH_CARD = 'img_birthday_card_dataurl';
const LS_GREETING       = 'greeting_text';

/* Galaxy keys cho IndexedDB */
const GAL_KEYS = [
  'img_galaxy_1',
  'img_galaxy_2',
  'img_galaxy_3',
  'img_galaxy_4',
  'img_galaxy_5'
];

/* =======================================================
   2. DOM elements
   ======================================================= */
const pvIndex      = document.getElementById('pv_index');
const pvBirthTop   = document.getElementById('pv_birthday_top');
const pvBirthCard  = document.getElementById('pv_birthday_card');

const pvGalaxy1    = document.getElementById('pv_galaxy_1');
const pvGalaxy2    = document.getElementById('pv_galaxy_2');
const pvGalaxy3    = document.getElementById('pv_galaxy_3');
const pvGalaxy4    = document.getElementById('pv_galaxy_4');
const pvGalaxy5    = document.getElementById('pv_galaxy_5');

const fIndex       = document.getElementById('f_index');
const fBirthTop    = document.getElementById('f_birthday_top');
const fBirthCard   = document.getElementById('f_birthday_card');

const fGalaxy1     = document.getElementById('f_galaxy_1');
const fGalaxy2     = document.getElementById('f_galaxy_2');
const fGalaxy3     = document.getElementById('f_galaxy_3');
const fGalaxy4     = document.getElementById('f_galaxy_4');
const fGalaxy5     = document.getElementById('f_galaxy_5');

const pwEl         = document.getElementById('pw');
const greetingEl   = document.getElementById('greeting');
const msg          = document.getElementById('msg');

/* =======================================================
   3. Helper UI
   ======================================================= */
function showMsg(text, ok=true){
  msg.textContent = text;
  msg.className = ok ? 'ok' : 'warn';
  setTimeout(()=>{ msg.textContent=''; }, 2500);
}
function setPreview(el, dataURL, fallbackLabel){
  el.innerHTML = dataURL
    ? `<img src="${dataURL}" alt="preview">`
    : `<small>${fallbackLabel}</small>`;
}

/* =======================================================
   4. localStorage image helper cho 3 ·∫£nh ch√≠nh
   ======================================================= */
function fileToDataURL(file){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = e => resolve(e.target.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

/* =======================================================
   5. IndexedDB helpers cho Galaxy
   ======================================================= */
const DB_NAME = 'birthdayDB';
const DB_VER  = 1;
const STORE   = 'images';

function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = () => {
      const db = req.result;
      if (!db.objectStoreNames.contains(STORE)) {
        db.createObjectStore(STORE);
      }
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror   = () => reject(req.error);
  });
}

async function saveImageToDB(key, fileBlob) {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE, 'readwrite');
    tx.objectStore(STORE).put(fileBlob, key); // upsert
    tx.oncomplete = () => resolve(true);
    tx.onerror    = () => reject(tx.error);
  });
}

async function getImageFromDB(key){
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE,'readonly');
    const req = tx.objectStore(STORE).get(key);
    req.onsuccess = () => resolve(req.result || null);
    req.onerror   = () => reject(req.error);
  });
}

/* load preview Galaxy t·ª´ DB -> objectURL */
async function loadGalaxyPreview() {
  const blobs = await Promise.all(GAL_KEYS.map(k => getImageFromDB(k)));
  const previews = blobs.map(b => b ? URL.createObjectURL(b) : null);

  setPreview(pvGalaxy1, previews[0], 'Galaxy #1\nCh∆∞a c√≥ ·∫£nh');
  setPreview(pvGalaxy2, previews[1], 'Galaxy #2\nCh∆∞a c√≥ ·∫£nh');
  setPreview(pvGalaxy3, previews[2], 'Galaxy #3\nCh∆∞a c√≥ ·∫£nh');
  setPreview(pvGalaxy4, previews[3], 'Galaxy #4\nCh∆∞a c√≥ ·∫£nh');
  setPreview(pvGalaxy5, previews[4], 'Galaxy #5\nCh∆∞a c√≥ ·∫£nh');
}

/* =======================================================
   6. LOAD ban ƒë·∫ßu
   ======================================================= */
async function loadAll(){
  // previews t·ª´ localStorage cho 3 ·∫£nh ch√≠nh
  setPreview(
    pvIndex,
    localStorage.getItem(LS_IMG_INDEX) || '',
    'Ch∆∞a c√≥ ·∫£nh'
  );
  setPreview(
    pvBirthTop,
    localStorage.getItem(LS_IMG_BIRTH_TOP) || '',
    'M·∫∑c ƒë·ªãnh: assets/cute-cake.png'
  );
  setPreview(
    pvBirthCard,
    localStorage.getItem(LS_IMG_BIRTH_CARD) || '',
    'M·∫∑c ƒë·ªãnh: assets/card-cute.jpg'
  );

  // text
  greetingEl.value = localStorage.getItem(LS_GREETING) || '';
  pwEl.value       = localStorage.getItem(LS_PW) || '';

  // preview Galaxy t·ª´ IndexedDB
  await loadGalaxyPreview();
}
loadAll();

/* =======================================================
   7. SAVE
   ======================================================= */
document.getElementById('btnSave').addEventListener('click', async ()=>{
  try{
    // save password + greeting
    localStorage.setItem(LS_PW, (pwEl.value||'').trim());
    localStorage.setItem(LS_GREETING, (greetingEl.value||'').trim());

    // save 3 ·∫£nh ch√≠nh v√†o localStorage n·∫øu ng∆∞·ªùi d√πng v·ª´a ch·ªçn
    if (fIndex.files[0]) {
      const d = await fileToDataURL(fIndex.files[0]);
      localStorage.setItem(LS_IMG_INDEX, d);
      setPreview(pvIndex, d, '');
    }
    if (fBirthTop.files[0]) {
      const d = await fileToDataURL(fBirthTop.files[0]);
      localStorage.setItem(LS_IMG_BIRTH_TOP, d);
      setPreview(pvBirthTop, d, '');
    }
    if (fBirthCard.files[0]) {
      const d = await fileToDataURL(fBirthCard.files[0]);
      localStorage.setItem(LS_IMG_BIRTH_CARD, d);
      setPreview(pvBirthCard, d, '');
    }

    // save Galaxy images v√†o IndexedDB n·∫øu v·ª´a ch·ªçn
    async function handleGalaxyInput(fileInput, key, pvEl, fallbackText){
      if (fileInput.files[0]) {
        const blob = fileInput.files[0];
        await saveImageToDB(key, blob);
        const url = URL.createObjectURL(blob);
        setPreview(pvEl, url, fallbackText);
      }
    }

    await handleGalaxyInput(fGalaxy1, 'img_galaxy_1', pvGalaxy1, 'Galaxy #1\nCh∆∞a c√≥ ·∫£nh');
    await handleGalaxyInput(fGalaxy2, 'img_galaxy_2', pvGalaxy2, 'Galaxy #2\nCh∆∞a c√≥ ·∫£nh');
    await handleGalaxyInput(fGalaxy3, 'img_galaxy_3', pvGalaxy3, 'Galaxy #3\nCh∆∞a c√≥ ·∫£nh');
    await handleGalaxyInput(fGalaxy4, 'img_galaxy_4', pvGalaxy4, 'Galaxy #4\nCh∆∞a c√≥ ·∫£nh');
    await handleGalaxyInput(fGalaxy5, 'img_galaxy_5', pvGalaxy5, 'Galaxy #5\nCh∆∞a c√≥ ·∫£nh');

    showMsg('ƒê√£ l∆∞u ‚úì', true);
  }catch(e){
    console.error(e);
    showMsg('L·ªói khi l∆∞u!', false);
  }
});

/* =======================================================
   8. CLEAR
   ======================================================= */
document.getElementById('btnClear').addEventListener('click', async ()=>{
  if(!confirm('X√≥a h·∫øt c√†i ƒë·∫∑t (·∫£nh + m·∫≠t kh·∫©u + Galaxy)?')) return;

  // clear localStorage
  [LS_PW, LS_IMG_INDEX, LS_IMG_BIRTH_TOP, LS_IMG_BIRTH_CARD, LS_GREETING].forEach(
    k=> localStorage.removeItem(k)
  );

  // clear IndexedDB store
  const db = await openDB();
  await new Promise((resolve,reject)=>{
    const tx = db.transaction(STORE,'readwrite');
    const store = tx.objectStore(STORE);
    GAL_KEYS.forEach(k => store.delete(k));
    tx.oncomplete = ()=>resolve(true);
    tx.onerror    = ()=>reject(tx.error);
  });

  await loadAll();
  showMsg('ƒê√£ x√≥a ‚úì', true);
});

/* =======================================================
   9. EXPORT / IMPORT
   ======================================================= */
/*
  EXPORT ch·ªâ bao g·ªìm:
    - pw
    - greeting
    - img_index_dataurl
    - img_birthday_top_dataurl
    - img_birthday_card_dataurl

  KH√îNG bao g·ªìm ·∫£nh Galaxy v√¨ ch√∫ng n·∫±m trong IndexedDB.
*/
document.getElementById('btnExport').addEventListener('click', ()=>{
  const data = {
    pw: localStorage.getItem(LS_PW) || '',
    img_index: localStorage.getItem(LS_IMG_INDEX) || '',
    img_birthday_top: localStorage.getItem(LS_IMG_BIRTH_TOP) || '',
    img_birthday_card: localStorage.getItem(LS_IMG_BIRTH_CARD) || '',
    greeting: localStorage.getItem(LS_GREETING) || ''
    // galaxy_* intentionally NOT exported
  };
  const blob = new Blob([JSON.stringify(data)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'lovely-settings.json';
  a.click();
  URL.revokeObjectURL(a.href);
  showMsg('ƒê√£ export JSON (kh√¥ng g·ªìm Galaxy)', true);
});

document.getElementById('btnImport').addEventListener('click', ()=>{
  document.getElementById('imp').click();
});

document.getElementById('imp').addEventListener('change', async (e)=>{
  const file = e.target.files[0];
  if(!file) return;
  try{
    const txt = await file.text();
    const data = JSON.parse(txt);
    if(typeof data !== 'object') throw new Error('Bad file');

    if('pw' in data) localStorage.setItem(LS_PW, data.pw||'');
    if('img_index' in data) localStorage.setItem(LS_IMG_INDEX, data.img_index||'');
    if('img_birthday_top' in data) localStorage.setItem(LS_IMG_BIRTH_TOP, data.img_birthday_top||'');
    if('img_birthday_card' in data) localStorage.setItem(LS_IMG_BIRTH_CARD, data.img_birthday_card||'');
    if('greeting' in data) localStorage.setItem(LS_GREETING, data.greeting||'');

    await loadAll();
    showMsg('ƒê√£ import ‚úì (Galaxy gi·ªØ nguy√™n hi·ªán t·∫°i)', true);
  }catch(err){
    console.error(err);
    showMsg('File kh√¥ng h·ª£p l·ªá!', false);
  }
});
</script>
</body>
</html>
