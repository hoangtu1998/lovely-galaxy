<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>Galaxy — Birthday Orbit ✨</title>
  <meta name="theme-color" content="#000000">
  <style>
    html, body {
      height:100%;
      margin:0;
      background:#000;
      overflow:hidden;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
    }

    #cv{
      position:fixed;
      inset:0;
      z-index:1;
      display:block;
    }

    #wishBox{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
      text-align:center;

      font-family: "Dancing Script", system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      font-size:clamp(24px,4vw,40px);
      line-height:1.3;
      color:#fff;

      text-shadow:
        0 0 12px rgba(255,100,200,1),
        0 0 28px rgba(255,0,120,0.8),
        0 4px 10px rgba(0,0,0,.8);

      background: radial-gradient(
        circle at 50% 50%,
        rgba(0,0,0,0.6) 0%,
        rgba(0,0,0,0.0) 60%
      );

      pointer-events:none;
      opacity:0;
      transition: opacity .8s ease;
      z-index:5;
    }
  </style>
</head>
<body>

  <div id="wishBox">
    Chúc mừng sinh nhật 🎂
    Chúc bạn luôn xinh đẹp, hạnh phúc
    và được yêu thương nhất vũ trụ 💖✨
  </div>

  <canvas id="cv"></canvas>

<script>
/* ================== SETTINGS / LOCAL DATA ================== */
const LS_IMG_GALAXY = 'img_galaxy_dataurl';
const LS_WISH_TEXT  = 'wish_text';

const savedWish = localStorage.getItem(LS_WISH_TEXT)
  || "Chúc mừng sinh nhật 🎂 Chúc bạn luôn xinh đẹp, hạnh phúc và được yêu thương nhất vũ trụ 💖✨";

document.getElementById('wishBox').textContent = savedWish;
setTimeout(()=> {
  document.getElementById('wishBox').style.opacity = 1;
}, 10000);

/* ================== CANVAS SETUP ================== */
const cv = document.getElementById('cv');
const cx = cv.getContext('2d', { alpha: false });

let DPR = Math.min((window.devicePixelRatio||1), 1.75);
function resize(){
  cv.width  = Math.max(1, Math.floor(innerWidth  * DPR));
  cv.height = Math.max(1, Math.floor(innerHeight * DPR));
  cv.style.width  = innerWidth + 'px';
  cv.style.height = innerHeight + 'px';
  cx.setTransform(DPR,0,0,DPR,0,0);
}
addEventListener('resize', resize);
resize();

/* ================== PERF PRESET ================== */
const mem = navigator.deviceMemory || 4;
const LOW = mem <= 4 && innerWidth < 900;

const STAR_COUNT    = LOW ? 1800 : 3200;
const R_MAX         = 420;
const THICKNESS     = 22;
const ORBIT_SPRITES = 8; // ít hơn -> dễ nhìn spotlight từng ảnh

/* ================== CAMERA / STATE ================== */
let autoSpeed = 0.01;
let userRotY = 0.0;
let userRotX = 0.18;
const dist = 520; // không zoom toàn cảnh

/* ================== GALAXY POINT CLOUD ================== */
const points = [];
for (let i=0; i<STAR_COUNT; i++){
  const radius    = Math.pow(Math.random(), 0.55) * R_MAX;
  const arms      = 4;
  const baseAngle = Math.random() * Math.PI * 2;
  const twist     = radius * 0.17;
  const angle     = baseAngle
                  + Math.floor(Math.random()*arms) * (Math.PI*2/arms)
                  + twist;

  const y = (Math.random()-0.5) * THICKNESS;
  const x = Math.cos(angle) * radius;
  const z = Math.sin(angle) * radius;

  const hueBase = 200 + (angle/(Math.PI*2))*120;
  const sat     = 88;
  const light   = 55 + Math.random()*12;

  points.push({x,y,z,hueBase,sat,light});
}

/* ================== BACKGROUND STARS ================== */
const stars = Array.from({length: LOW ? 900 : 1400}, () => ({
  x:(Math.random()-0.5)*2600,
  y:(Math.random()-0.5)*1600,
  z: Math.random()*2400 + 400
}));

/* ================== SPRITES (ẢNH QUAY) ================== */
const spriteImg = new Image();
const savedGalaxy = localStorage.getItem(LS_IMG_GALAXY);
// đổi thành ảnh bạn muốn show
const FALLBACK_GALAXY = 'assets/cake-cute.png';
spriteImg.src = savedGalaxy || FALLBACK_GALAXY;

const sprites = [];
for(let i=0;i<ORBIT_SPRITES;i++){
  const a = i / ORBIT_SPRITES * Math.PI*2;
  const r = 280 + Math.sin(i*0.7)*18;
  sprites.push({
    baseA: a,
    r,
    y: (Math.random()-0.5)*30,
    s: 0.9 + Math.random()*0.4
  });
}

/* ================== INTERACTION: KÉO XOAY ================== */
let dragging=false, px=0, py=0;

cv.addEventListener('mousedown', e=>{
  dragging=true; px=e.clientX; py=e.clientY;
});
addEventListener('mouseup', ()=> dragging=false);
addEventListener('mousemove', e=>{
  if(!dragging) return;
  const dx=e.clientX-px, dy=e.clientY-py;
  px=e.clientX; py=e.clientY;
  userRotY += dx*0.006;
  userRotX += dy*0.006;
  userRotX = Math.max(-1.2, Math.min(1.2, userRotX));
});

cv.addEventListener('touchstart', e=>{
  if(e.touches.length===1){
    dragging=true;
    px=e.touches[0].clientX;
    py=e.touches[0].clientY;
  }
},{passive:true});

cv.addEventListener('touchmove', e=>{
  if(e.touches.length===1 && dragging){
    const t0=e.touches[0];
    const dx=t0.clientX-px, dy=t0.clientY-py;
    px=t0.clientX; py=t0.clientY;
    userRotY+=dx*0.006;
    userRotX+=dy*0.006;
    userRotX=Math.max(-1.2,Math.min(1.2,userRotX));
  }
},{passive:true});

cv.addEventListener('touchend', ()=>{
  dragging=false;
},{passive:true});

/* ================== TOÁN CHIẾU 3D -> 2D ================== */
function proj(x,y,z){
  const cY = Math.cos(userRotY), sY = Math.sin(userRotY);
  const cX = Math.cos(userRotX), sX = Math.sin(userRotX);

  let X = x*cY - z*sY;
  let Z = x*sY + z*cY;
  let Y = y*cX - Z*sX;
  Z = y*sX + Z*cX + dist;

  const f = 450 / Z;
  return {
    x: innerWidth/2  + X*f,
    y: innerHeight/2 + Y*f,
    s: f
  };
}

/* ================== SPOTLIGHT LOGIC (CHU KỲ) ================== */
/*
  mode "orbit": tất cả ảnh quay quanh.
  mode "spotlight": pause quay, chỉ show 1 ảnh giữa màn hình phóng to x3.
*/
let mode = "orbit";
let tOrbit = 0;              // thời gian quay
let orbitFrameCounter = 0;   // đếm frame trong chế độ orbit
const ORBIT_FRAMES_BEFORE_SPOTLIGHT = 20; // ~4 giây quay trước khi phóng to

let spotlightFrameCounter = 0;
const SPOTLIGHT_FRAMES = 10; // ~2 giây đứng im to

let spotlightSpriteIndex = 0; // sprite nào sẽ được phóng to kế tiếp
let spotlightImageScale = 1;  // scale chụp lúc vào spotlight (để nhìn mượt)

/* ================== LOOP ================== */
let sortToggle = 0;
let pulsing = false;

(function loop(){
  requestAnimationFrame(loop);

  // --- 1. cập nhật state (tăng tOrbit hay không) ---
  if (mode === "orbit"){
    tOrbit += 1;
    userRotY += autoSpeed;
    orbitFrameCounter++;

    if (orbitFrameCounter >= ORBIT_FRAMES_BEFORE_SPOTLIGHT){
              // chuyển sang spotlight
        mode = "spotlight";
        orbitFrameCounter = 0;
        spotlightFrameCounter = 0;

        // chỉ ghi nhớ index sẽ show lần này
        spotlightSpriteIndex = spotlightSpriteIndex % sprites.length;

        // chuẩn bị index cho lần tới
        // (tăng trước cho vòng sau)
        spotlightSpriteIndexNext = (spotlightSpriteIndex + 1) % sprites.length;

    }

  } else if (mode === "spotlight"){
    // KHÔNG tăng tOrbit => tất cả đứng im
    spotlightFrameCounter++;
    if (spotlightFrameCounter >= SPOTLIGHT_FRAMES){
  mode = "orbit";
  // chuyển index hiện hành sang indexNext
  spotlightSpriteIndex = spotlightSpriteIndexNext;
}

  }

  // --- 2. vẽ nền ---
  const gx = innerWidth*0.6;
  const gy = innerHeight*0.5;
  const gr = Math.max(innerWidth,innerHeight);
  const bg = cx.createRadialGradient(gx,gy,0,gx,gy,gr);
  bg.addColorStop(0,'rgba(20,30,60,0.55)');
  bg.addColorStop(0.6,'rgba(10,8,20,0.9)');
  bg.addColorStop(1,'rgba(0,0,0,1)');
  cx.fillStyle = bg;
  cx.fillRect(0,0,innerWidth,innerHeight);

  // sao xa
  cx.globalAlpha = 0.7;
  cx.fillStyle = '#ffffff';
  for(const s of stars){
    const p2 = proj(s.x, s.y, s.z);
    const rStar = Math.max(.4, 1.2*p2.s);
    cx.beginPath();
    cx.arc(p2.x, p2.y, rStar, 0, Math.PI*2);
    cx.fill();
  }
  cx.globalAlpha = 1;

  // ngân hà
  let drawList = points;
  if((sortToggle ^= 1)){
    drawList = points.slice().sort((a,b)=>{
      const za = a.x*Math.sin(userRotY)+a.z*Math.cos(userRotY);
      const zb = b.x*Math.sin(userRotY)+b.z*Math.cos(userRotY);
      return za - zb;
    });
  }

  const pulseAmt = pulsing ? (1 + Math.sin(tOrbit*0.06)*0.06) : 1;

  for(const p0 of drawList){
    const wobble = Math.sin((p0.x+p0.z+tOrbit*0.8)*0.01)*0.5;
    const pr = proj(
      p0.x * pulseAmt,
      (p0.y + wobble) * pulseAmt,
      p0.z * pulseAmt
    );

    const hue  = (p0.hueBase + 20*Math.sin(tOrbit*0.02)) % 360;
    const size = Math.min(2.8, 1.8*pr.s + 0.6);

    cx.fillStyle = `hsla(${hue}, ${p0.sat}%, ${p0.light}%, 0.9)`;
    cx.beginPath();
    cx.arc(pr.x, pr.y, size, 0, Math.PI*2);
    cx.fill();
  }

  // --- 3. vẽ sprites ---
  if (mode === "spotlight"){
    // chỉ vẽ 1 ảnh: sprite spotlightSpriteIndex-1 (vì ta đã advance index sau khi chụp)
    const idxToShow =
      (spotlightSpriteIndex - 1 + sprites.length) % sprites.length;
    const sp = sprites[idxToShow];

    // scale phóng to x3
    const scaleNow = spotlightImageScale * 4;
    const w = 64 * scaleNow;
    const h = w;
    const rr = Math.min(10*scaleNow, w/4);

    cx.save();
    // ép nó ra đúng giữa màn hình
    cx.translate(innerWidth/2, innerHeight/2);

    cx.fillStyle = 'rgba(255,255,255,0.15)';
    roundRect(cx, -w/2, -h/2, w, h, rr);
    cx.fill();

    if (spriteImg.complete && w>2 && h>2){
      cx.save();
      roundRect(cx, -w/2, -h/2, w, h, rr);
      cx.clip();
      cx.drawImage(spriteImg, -w/2, -h/2, w, h);
      cx.restore();
    }

    cx.restore();

  } else {
    // orbit mode: vẽ tất cả quay quanh
    for (let i=0;i<sprites.length;i++){
      const sp = sprites[i];
      const angNow = sp.baseA + tOrbit*(0.028 + sp.s*0.004);
      const px3 = Math.cos(angNow)*sp.r;
      const pz3 = Math.sin(angNow)*sp.r;
      const py3 = sp.y;

      const screen = proj(px3, py3, pz3);

      const scaleNow = sp.s * screen.s;
      const w = 80 * scaleNow;
      const h = w;
      const rr = Math.min(10*scaleNow, w/4);

      cx.save();
      cx.translate(screen.x, screen.y);

      cx.fillStyle = 'rgba(255,255,255,0.15)';
      roundRect(cx, -w/2, -h/2, w, h, rr);
      cx.fill();

      if (spriteImg.complete && w>2 && h>2){
        cx.save();
        roundRect(cx, -w/2, -h/2, w, h, rr);
        cx.clip();
        cx.drawImage(spriteImg, -w/2, -h/2, w, h);
        cx.restore();
      }

      cx.restore();
    }
  }

})(); // end loop

/* ================== HELPER ================== */
function roundRect(ctx, x, y, w, h, r){
  ctx.beginPath();
  ctx.moveTo(x+r, y);
  ctx.arcTo(x+w, y,   x+w, y+h, r);
  ctx.arcTo(x+w, y+h, x,   y+h, r);
  ctx.arcTo(x,   y+h, x,   y,   r);
  ctx.arcTo(x,   y,   x+w, y,   r);
  ctx.closePath();
}
</script>
</body>
</html>
