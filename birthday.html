<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>Birthday ‚ú®</title>
  <meta name="theme-color" content="#000000">

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Playpen+Sans:wght@400;700&display=swap" rel="stylesheet">
  <!-- Font cho caption Galaxy -->
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@600;700&display=swap" rel="stylesheet">

  <style>
    *{box-sizing:border-box;margin:0;padding:0;}
    html,body{height:100%;}
    body{
      overflow:hidden;
      color:#fff;
      font-family:"Playpen Sans",sans-serif;
      background:
        radial-gradient(circle at 50% 30%,
          rgba(255,170,200,1) 0%,
          rgba(255,120,180,1) 40%,
          rgba(90,0,60,1) 100%);
      background-color:#ff7ab4;
    }

    /* ===== SCENE 1: BIRTHDAY ===== */

    #pinkBg{
      position:fixed;
      inset:0;
      background:linear-gradient(180deg,#ffc0cb 0%,#ff99cc 50%,#ff66b2 100%);
      z-index:-1;
      pointer-events:none;
      user-select:none;
    }

    .bgLayerImg{
      position:fixed; inset:0; z-index:0; pointer-events:none; user-select:none;
      background: linear-gradient(rgba(255,170,200,0.4),rgba(255,120,180,0.5)), url("assets/cute-cake.png");
      background-position:center; background-size:cover; background-repeat:no-repeat; background-attachment:fixed;
      filter:saturate(1.2) brightness(1.05);
    }

    #matrix,#fireworks,#cuteLayer{
      position:fixed; inset:0; pointer-events:none;
    }
    #matrix{ z-index:1; }
    #fireworks{ z-index:2; }
    #cuteLayer{ z-index:3; }

    /* ch·ªØ r∆°i */
    .rainAllWrap{
      position:fixed;
      left:50%; top:50%;
      transform:translate(-50%,-60%);
      z-index:5;
      width:100%;
      max-width:90vw;
      text-align:center;
      pointer-events:none;
    }

    .rainWrap{
      opacity:0;
      margin-bottom: clamp(32px, 4vw, 42px);
    }
    .rainWrap.show{opacity:1;}

    .rain{
      display:inline-block;
      font-weight:700;
      font-size:clamp(24px,3.5vw,42px);
      color:#ff2b2b;
      text-shadow:
        0 0 10px rgba(255,50,80,0.9),
        0 0 24px rgba(255,0,70,0.8),
        0 3px 8px rgba(0,0,0,0.6);
      font-family:"Dancing Script",cursive;
    }

    /* l√†m d√≤ng "B·∫°n iu" to h∆°n m·ªôt ch√∫t */
    .line2 .rain{
      font-size:clamp(30px,4.2vw,52px);
      letter-spacing:0.04em;
    }

    .line3 .rain{
      font-family:"Playpen Sans",sans-serif;
      font-size:clamp(22px,3.2vw,38px);
      color:#ff2b2b; font-weight:700;
      text-shadow:
        0 0 8px rgba(255,60,90,0.9),
        0 0 22px rgba(255,20,70,0.7),
        0 3px 8px rgba(0,0,0,0.6);
    }

    .drop{
      display:inline-block;
      opacity:0;
      transform:translateY(-40px);
      margin-right: 0.01em;
    }
    @keyframes dropIn{
      0%{opacity:0;transform:translateY(-40px);}
      60%{opacity:1;transform:translateY(8px);}
      80%{transform:translateY(-4px);}
      100%{opacity:1;transform:translateY(0);}
    }
    .drop.animate{animation:dropIn 1.8s ease-out forwards;}

    @media (max-width: 390px){
      .rain{ letter-spacing: 0.10em; word-spacing: 0.14em; }
      .line3 .rain{ letter-spacing: 0.12em; word-spacing: 0.16em; }
      .drop{ margin-right: 0.04em; }
    }

    .giftWrap{
      position:fixed; left:0; right:0; bottom:12vh;
      display:grid; place-items:center;
      z-index:6; text-align:center;
      opacity:0;
      transform:translateY(10px) scale(.98);
      pointer-events:none;
      transition: opacity .6s ease, transform .6s ease;
    }
    .giftWrap.show{
      opacity:1;
      transform:translateY(0) scale(1);
      pointer-events:auto;
    }

    .giftEmoji{
      position:relative;
      font-size:clamp(80px,12vw,130px);
      line-height:1;
      cursor:pointer;
      display:inline-block;
      animation:shake 1s infinite;
      transform-origin:center bottom;
      filter:drop-shadow(0 4px 8px rgba(0,0,0,.8));
    }
    .giftText{
      position:absolute; top:60%; left:50%; transform:translate(-50%,-50%);
      color:#fff; font-size:clamp(20px,3vw,28px); font-weight:700;
      text-shadow:0 2px 6px rgba(0,0,0,.7);
      pointer-events:none; line-height:1.2; text-align:center;
      font-family:"Playpen Sans",sans-serif;
    }
    .giftEmoji.open{animation:none;}
    .giftEmoji::before{
      content:"üéÅ"; position:absolute; left:0;right:0;top:0; text-align:center;
      font-size:inherit; line-height:1; transform-origin:center bottom; pointer-events:none; opacity:0;
    }
    .giftEmoji.open::before{
      opacity:1; animation:lidFlip .6s ease-out forwards;
      filter:drop-shadow(0 8px 12px rgba(255,105,180,.7));
    }
    @keyframes lidFlip{
      0%{transform:translateY(0) rotateX(0deg) scale(1);}
      60%{transform:translateY(-40px) rotateX(70deg) scale(1.05);}
      100%{transform:translateY(-60px) rotateX(110deg) scale(1.05);}
    }
    @keyframes shake{
      0%,100% { transform: translateY(0) rotate(0deg) scale(1); }
      10%     { transform: translateY(-4px) rotate(-4deg) scale(1.03); }
      20%     { transform: translateY(2px) rotate(3deg) scale(1.04); }
      30%     { transform: translateY(-6px) rotate(-6deg) scale(1.05); }
      40%     { transform: translateY(3px) rotate(4deg) scale(1.03); }
      50%     { transform: translateY(-8px) rotate(-4deg) scale(1.06); }
      60%     { transform: translateY(4px) rotate(4deg) scale(1.03); }
      70%     { transform: translateY(-5px) rotate(-3deg) scale(1.05); }
      80%     { transform: translateY(2px) rotate(2deg) scale(1.02); }
      90%     { transform: translateY(-3px) rotate(-2deg) scale(1.03); }
    }

    canvas{image-rendering:pixelated;}

    /* ===== SCENE 2: GALAXY (CSS CAROUSEL + CANVAS BACKGROUND) ===== */

    :root{
      --bg1:#0f0820;        /* t√≠m ƒë·∫≠m */
      --bg2:#061326;        /* xanh ƒë·∫≠m */
      --pink:#ff4bd6;       /* neon h·ªìng */
      --cyan:#53e5ff;       /* neon xanh */
      --card-size: 150px;   /* k√≠ch th∆∞·ªõc ·∫£nh */
      --radius: 18px;       /* bo g√≥c ·∫£nh */
      --ringZ: 300px;       /* b√°n k√≠nh tr·ª•c Z (ƒë·ªô s√¢u 3D) */
      --spin-sec: 18s;      /* th·ªùi gian quay 1 v√≤ng */
    }

    /* Canvas n·ªÅn v≈© tr·ª• galaxy */
    #cv{
      position:fixed;
      inset:0;
      z-index:0;
      display:block;
      background:#000;
    }

    /* L·ªùi ch√∫c (tr√™n ƒë·∫ßu) */
    #wishBox{
      position:fixed;
      top:0;
      left:0;
      width:100%;
      padding:28px 16px;
      text-align:center;

      font-family: "Dancing Script", system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      font-size:clamp(24px,4vw,40px);
      line-height:1.35;
      color:#fff;

      text-shadow:
        0 0 12px rgba(255,100,200,1),
        0 0 28px rgba(255,0,120,0.8),
        0 4px 10px rgba(0,0,0,.8);

      background: linear-gradient(to bottom, rgba(0,0,0,.45), rgba(0,0,0,0));

      pointer-events:none;
      opacity:0;
      transition: opacity .8s ease;
      z-index:15;

      display:block;
    }
  
    @media (max-width: 480px){
      #wishBox{ transform: translateX(-3.5vw); }
    }
    /* Ch·ªØ l·ªùi ch√∫c ki·ªÉu r∆°i t·ª´ng k√Ω t·ª± ·ªü galaxy */
    #wishBox .wish-ch {
      display:inline-block;
      opacity:0;
      transform:translateY(-14px);
      animation:wishDrop .45s ease-out forwards;
    }
    
    @keyframes wishDrop{
      0%  { opacity:0; transform:translateY(-18px); }
      60% { opacity:1; transform:translateY(4px); }
      85% { transform:translateY(-2px); }
      100%{ opacity:1; transform:translateY(0); }
    }

    /* N·ªÅn khung galaxy */
    #scene-galaxy{
      position:fixed;
      inset:0;
      background:
        radial-gradient(1200px 600px at 20% 30%, rgba(255,77,206,.18), transparent 60%),
        radial-gradient(1200px 600px at 80% 30%, rgba(83,229,255,.18), transparent 60%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
    }

    .stage{
      position:fixed;
      inset:0;
      display:grid;
      place-items:center;
      perspective:1200px;
      font-family:Quicksand, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      z-index:5; /* n·ªïi tr√™n canvas */
    }

    /* SVG tr√°i tim neon */
    .neon-layer{ position:absolute; inset:0; pointer-events:none }
    svg{
      position:absolute;
      width:min(96vmin, 900px);
      height:auto;
      left:50%;
      top:8%;
      transform:translateX(-50%);
    }
    .neon{
      fill:none;
      stroke-linecap:round;
      stroke-linejoin:round;
      stroke-width:14;
      stroke-dasharray: var(--len, 2000);
      stroke-dashoffset: var(--len, 2000);
      animation: draw var(--heart-speed,1.0s) linear infinite;
      filter:none;
    }
    .pink{ stroke: var(--pink); animation-delay: 0s; }
    .cyan{ stroke: var(--cyan); animation-delay: var(--heart-speed,1.0s); }
    @keyframes draw{
      0%   { stroke-dashoffset: var(--len); }
      100% { stroke-dashoffset: 0; }
    }

    /* Carousel ·∫£nh 3D */
    .carousel{
      position:relative;
      width: calc(1px * 2 * var(--ringZ));
      height:420px;
      transform-style:preserve-3d;
      opacity:0;
      pointer-events:none;
      transition:opacity .35s ease;
      z-index:10;
    }
    .carousel.spinning{ animation: spin var(--spin-sec) linear infinite }
    @keyframes spin{
      from{ transform: rotateY(0deg) }
      to  { transform: rotateY(360deg) }
    }

    .card{
      position:absolute;
      left:50%; top:50%;
      width:var(--card-size);
      height:calc(var(--card-size) * 1.35);
      transform-style:preserve-3d;
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 8px 28px rgba(0,0,0,.45);
      transition: transform 900ms cubic-bezier(.2,.7,.2,1)
    }
    .img{
      position:absolute;
      inset:0;
      background:#111 center/cover no-repeat;
      box-shadow: inset 0 0 20px rgba(255,255,255,.08)
    }
    .glow-pink{
      box-shadow: 0 8px 28px rgba(0,0,0,.45), 0 0 26px rgba(255,75,214,.35)
    }
    .glow-cyan{
      box-shadow: 0 8px 28px rgba(0,0,0,.45), 0 0 26px rgba(83,229,255,.35)
    }
    .pulse{
      animation:pulse 2.4s ease-in-out infinite
    }
    @keyframes pulse{
      0%,100%{ filter: drop-shadow(0 0 10px rgba(255,255,255,.2)) }
      50%    { filter: drop-shadow(0 0 22px rgba(255,255,255,.45)) }
    }

    /* THANH LED RGB CH·ªÆ HAPPY BIRTHDAY */
    .led{
      position:fixed;
      left:50%;
      transform:translateX(-50%) translateY(10px);
      bottom:28px;
      width:82vw;
      max-width:720px;
      padding:6px 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.25);
      background:linear-gradient(
        90deg,
        red, orange, yellow, lime, cyan, blue, magenta, red
      );
      background-size:300% 100%;
      animation:flow 1.2s linear infinite;
      box-shadow:0 0 24px rgba(255,255,255,.4);
      z-index:10;

      opacity:0;
      pointer-events:none;
      transition:opacity .6s ease, transform .6s ease;
    }

    .led-text{
      font-family:Quicksand, system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      font-weight:700;
      text-transform:uppercase;
      font-size:clamp(14px,2.2vw,18px);
      letter-spacing:0.16em;
      text-align:center;
      color:transparent;
      -webkit-background-clip:text;
      background-clip:text;
      text-shadow:0 0 14px rgba(255,255,255,.8);
    }

    .led.show{
      opacity:1;
      transform:translateX(-50%) translateY(0);
    }

    @keyframes flow{
      from{ background-position:0 0 }
      to  { background-position:300% 0 }
    }

  </style>
</head>
<body>

  <!-- SCENE 1: BIRTHDAY -->
  <div id="scene-birthday">
    <div id="pinkBg"></div>
    <div class="bgLayerImg" id="bgLayerDynamic"></div>

    <canvas id="matrix"></canvas>
    <canvas id="fireworks"></canvas>
    <canvas id="cuteLayer"></canvas>

    <!-- ch·ªØ -->
    <div class="rainAllWrap">
      <div class="rainWrap line1" aria-hidden="true">
        <div class="rain">
          <span class="drop">C</span><span class="drop">H</span><span class="drop">√ö</span><span class="drop">C</span><span class="drop">&nbsp;</span>
          <span class="drop">M</span><span class="drop">·ª™</span><span class="drop">N</span><span class="drop">G</span><span class="drop">&nbsp;</span>
          <span class="drop">S</span><span class="drop">I</span><span class="drop">N</span><span class="drop">H</span><span class="drop">&nbsp;</span>
          <span class="drop">N</span><span class="drop">H</span><span class="drop">·∫¨</span><span class="drop">T</span><span class="drop">!</span>
        </div>
      </div>

      <div class="rainWrap line2" aria-hidden="true">
        <div class="rain">
          <span class="drop">B</span><span class="drop">·∫°</span><span class="drop">n</span><span class="drop">&nbsp;</span>
          <span class="drop">i</span><span class="drop">u</span>
        </div>
      </div>

      <div class="rainWrap line3" aria-hidden="true">
        <div class="rain">
          <span class="drop">2</span><span class="drop">9</span><span class="drop">+</span>
        </div>
      </div>
    </div>

    <!-- h·ªôp qu√† -->
    <div class="giftWrap" id="giftWrap">
      <div class="giftEmoji" id="giftEmoji">
        üéÅ
        <div class="giftText">M·ªü qu√†</div>
      </div>
    </div>
  </div>

  <!-- SCENE 2: GALAXY (NEON HEART + CAROUSEL + BACKGROUND GALAXY) -->
  <div id="scene-galaxy" style="display:none;">
    <!-- N·ªÅn galaxy: sao + ng√¢n h√† -->
    <canvas id="cv"></canvas>

    <!-- L·ªùi ch√∫c tr√™n ƒë·∫ßu -->
    <div id="wishBox"></div>

    <!-- L·ªõp tim neon + carousel ·∫£nh -->
    <div class="stage">
      <!-- Tr√°i tim neon -->
    
      <!-- Carousel xoay ·∫£nh -->
      <div class="carousel" id="carousel"></div>

      <!-- 1 THANH LED HAPPY BIRTHDAY -->
      <div class="led led-text">Happy birthday</div>
    </div>
  </div>

  <!-- BGM CHUNG -->
  <audio id="bgm" preload="auto" loop playsinline style="display:none"></audio>

<script>
/* ===== KEYS d√πng chung ===== */
const LS_IMG_BIRTH_TOP  = 'img_birthday_top_dataurl';
const LS_GREETING       = 'greeting_text';

/* ===== BGM Player (d√πng chung cho c·∫£ 2 scene) ===== */
(async () => {
  const DEFAULT_BGM_URL = 'hpbd.mp3';
  const KEY_BGM = 'bgm_blob';
  const audio = document.getElementById('bgm');
  audio.volume = 0.4;

  function openDB(){
    return new Promise((resolve,reject)=>{
      const req = indexedDB.open('birthdayDB',1);
      req.onsuccess=()=>resolve(req.result);
      req.onupgradeneeded=()=>req.result.createObjectStore('images');
      req.onerror=()=>reject(req.error);
    });
  }
  async function dbGet(key){
    const db = await openDB();
    return new Promise((resolve,reject)=>{
      const tx=db.transaction('images','readonly');
      const req=tx.objectStore('images').get(key);
      req.onsuccess=()=>resolve(req.result||null);
      req.onerror=()=>reject(req.error);
    });
  }

  // ∆∞u ti√™n nh·∫°c user
  const blob = await dbGet(KEY_BGM);
  if(blob){
    const url = URL.createObjectURL(blob);
    audio.src = url;
  } else {
    audio.src = DEFAULT_BGM_URL;
  }

  // auto play (d·ª±a tr√™n pass t·ª´ index.html)
  const allowed = sessionStorage.getItem('allow_music')==='1';
  sessionStorage.removeItem('allow_music');

  const tryPlay = ()=>audio.play().catch(()=>{
    const kick = ()=>audio.play();
    window.addEventListener('pointerdown',kick,{once:true});
    window.addEventListener('keydown',kick,{once:true});
  });

  if(allowed) tryPlay();
})();
</script>

<script>
/* ===== BIRTHDAY: ƒë·ªïi n·ªÅn theo ·∫£nh user (birthday_top) ===== */
(function applyBirthdayTopBackground(){
  const KEY = LS_IMG_BIRTH_TOP;
  const bgLayer = document.getElementById('bgLayerDynamic');
  const topImg = localStorage.getItem(KEY);

  if (topImg) {
    bgLayer.style.background = `url("${topImg}") center / cover no-repeat fixed`;
    bgLayer.style.filter = 'none';

    const pink = document.getElementById('pinkBg');
    if (pink) pink.style.display = 'none';
    document.body.classList.add('no-pink-bg');
  }
})();

/* ===== BIRTHDAY: hi·ªáu ·ª©ng ch·ªØ r∆°i + hi·ªÉn th·ªã h·ªôp qu√† ===== */
function playLine(lineElem, callback){
  lineElem.classList.add('show');
  const letters = lineElem.querySelectorAll('.drop');
  letters.forEach((span, idx) => {
    const delay = 0.1 * (idx + 1);
    span.style.animationDelay = delay + 's';
    span.classList.add('animate');
  });
  const totalMs = (0.1 * letters.length + 1.8) * 1000;
  setTimeout(() => { if (callback) callback(); }, totalMs);
}

const line1 = document.querySelector('.rainWrap.line1');
const line2 = document.querySelector('.rainWrap.line2');
const line3 = document.querySelector('.rainWrap.line3');

const giftWrap = document.getElementById('giftWrap');

playLine(line1, () => {
  playLine(line2, () => {
    playLine(line3, () => {
      giftWrap.classList.add('show');
    });
  });
});

/* ===== BIRTHDAY: matrix text background ===== */
const cvsMatrix = document.getElementById('matrix');
const ctxM = cvsMatrix.getContext('2d');
const glyphs = 'HappyBirthdayüéÇ‚ú®';
let W,H,cols,drops,DPR_M;
function resizeMatrix(){
  DPR_M = Math.max(1, window.devicePixelRatio || 1);
  W = cvsMatrix.width = Math.floor(innerWidth * DPR_M);
  H = cvsMatrix.height = Math.floor(innerHeight * DPR_M);
  cvsMatrix.style.width = innerWidth + 'px';
  cvsMatrix.style.height = innerHeight + 'px';
  ctxM.setTransform(DPR_M,0,0,DPR_M,0,0);
  const step = 22;
  cols = Math.floor(innerWidth / step);
  drops = Array(cols).fill(0);
}
addEventListener('resize', resizeMatrix);
resizeMatrix();
(function drawMatrix(){
  requestAnimationFrame(drawMatrix);
  ctxM.clearRect(0,0,innerWidth,innerHeight);
  const step = 22;
  ctxM.font = 'bold 18px monospace';
  ctxM.globalCompositeOperation = 'source-over';
  for(let i=0;i<drops.length;i++){
    const ch = glyphs[Math.floor(Math.random()*glyphs.length)];
    const x = i*step;
    const y = drops[i]*step;
    ctxM.lineWidth = 3;
    ctxM.strokeStyle = 'rgba(255,255,255,0.8)';
    ctxM.strokeText(ch, x, y);
    ctxM.shadowColor = 'rgba(255,105,180,.8)';
    ctxM.shadowBlur = 12;
    ctxM.fillStyle = '#fff';
    ctxM.fillText(ch, x, y);
    ctxM.shadowBlur = 0;
    if (y > H && Math.random() > 0.97) { drops[i] = 0; } else { drops[i] += 0.5; }
  }
})();

/* ===== BIRTHDAY: ph√°o hoa ===== */
const fwCanvas = document.getElementById('fireworks');
const fwCtx = fwCanvas.getContext('2d');
let fwW, fwH, fireworks=[], particles=[];
function resizeFW(){ fwW = fwCanvas.width = innerWidth; fwH = fwCanvas.height = innerHeight; }
addEventListener('resize', resizeFW); resizeFW();

class Firework {
  constructor(){
    this.x=Math.random()*fwW; this.y=fwH;
    this.tx=Math.random()*fwW; this.ty=Math.random()*fwH*0.4+fwH*0.1;
    this.vx=(this.tx-this.x)/30; this.vy=(this.ty-this.y)/30; this.life=30;
    const rainbow=['#ff3366','#ff9933','#ffff33','#33ff66','#33ccff','#9966ff','#ff33cc'];
    this.color=rainbow[Math.floor(Math.random()*rainbow.length)];
  }
  update(){ this.x+=this.vx; this.y+=this.vy; this.life--; if(this.life<=0){ explode(this.x,this.y); return false;} return true; }
  draw(){ fwCtx.beginPath(); fwCtx.fillStyle=this.color; fwCtx.arc(this.x,this.y,2,0,Math.PI*2); fwCtx.fill(); }
}
class Particle {
  constructor(x,y){
    const angle=Math.random()*Math.PI*2; const speed=Math.random()*3+1;
    this.x=x; this.y=y; this.vx=Math.cos(angle)*speed; this.vy=Math.sin(angle)*speed;
    this.alpha=1; this.decay=Math.random()*0.02+0.015;
    const rainbow=['#ff3366','#ff9933','#ffff33','#33ff66','#33ccff','#9966ff','#ff33cc'];
    this.color=rainbow[Math.floor(Math.random()*rainbow.length)];
  }
  update(){ this.x+=this.vx; this.y+=this.vy; this.vy+=0.03; this.alpha-=this.decay; return this.alpha>0; }
  draw(){ fwCtx.globalAlpha=this.alpha; fwCtx.beginPath(); fwCtx.fillStyle=this.color; fwCtx.arc(this.x,this.y,2,0,Math.PI*2); fwCtx.fill(); fwCtx.globalAlpha=1; }
}
function explode(x,y){ for(let i=0;i<40;i++){ particles.push(new Particle(x,y)); } }
function loopFW(){
  requestAnimationFrame(loopFW);
  fwCtx.clearRect(0,0,fwW,fwH);
  if(Math.random()<0.08){ fireworks.push(new Firework()); }
  fireworks = fireworks.filter(fw=>{ const alive=fw.update(); fw.draw(); return alive; });
  particles = particles.filter(p=>{ const alive=p.update(); p.draw(); return alive; });
}
loopFW();

/* ===== BIRTHDAY: tuy·∫øt + tim ===== */
const cuteCanvas = document.getElementById('cuteLayer');
const cuteCtx = cuteCanvas.getContext('2d');
let cW, cH, snowflakes=[], critters=[];
const ENABLE_SNOW = true, ENABLE_CRITTERS = true;

function resizeCute(){ cW = cuteCanvas.width = innerWidth; cH = cuteCanvas.height = innerHeight; }
addEventListener('resize', resizeCute); resizeCute();

function initSnow(){
  snowflakes = [];
  for(let i=0;i<50;i++){
    snowflakes.push({ x:Math.random()*cW, y:Math.random()*cH, r:Math.random()*3+3, spdY:Math.random()*1+0.8, drift:(Math.random()*1-0.5) });
  }
}
function initCritters(){
  critters = [];
  const EMOJIS = ['üíñ','üíñ','üíñ','üíñ','üíñ','üíñ'];
  for(let i=0;i<6;i++){
    critters.push({ emoji:EMOJIS[i%EMOJIS.length], x:Math.random()*cW, y:Math.random()*cH,
      vx:(Math.random()<0.5?-1:1)*(1.5+Math.random()*1.5),
      vy:(Math.random()<0.5?-1:1)*(1.5+Math.random()*1.5),
      size:28+Math.random()*8 });
  }
}
if(ENABLE_SNOW) initSnow();
if(ENABLE_CRITTERS) initCritters();

function loopCute(){
  requestAnimationFrame(loopCute);
  cuteCtx.clearRect(0,0,cW,cH);

  if(ENABLE_SNOW){
    cuteCtx.fillStyle = "#fff";
    for(const f of snowflakes){
      f.y += f.spdY; f.x += f.drift;
      if(f.y > cH){ f.y = -10; f.x = Math.random()*cW; }
      cuteCtx.beginPath(); cuteCtx.globalAlpha = 0.9; cuteCtx.arc(f.x,f.y,f.r,0,Math.PI*2); cuteCtx.fill();
    }
    cuteCtx.globalAlpha = 1;
  }

  if(ENABLE_CRITTERS){
    for(const c of critters){
      c.x += c.vx; c.y += c.vy;
      if(c.x < 20){ c.x = 20; c.vx *= -1; }
      if(c.x > cW-20){ c.x = cW-20; c.vx *= -1; }
      if(c.y < 20){ c.y = 20; c.vy *= -1; }
      if(c.y > cH-20){ c.y = cH-20; c.vy *= -1; }

      cuteCtx.save();
      cuteCtx.translate(c.x, c.y);
      if(c.vx < 0){ cuteCtx.scale(-1,1); }
      cuteCtx.font = `${c.size}px "Segoe UI Emoji","Apple Color Emoji","Noto Color Emoji",sans-serif`;
      cuteCtx.textAlign = "center";
      cuteCtx.textBaseline = "middle";
      cuteCtx.fillText(c.emoji,0,0);
      cuteCtx.restore();
    }
  }
  cuteCtx.globalAlpha = 1;
}
loopCute();

/* ===== BIRTHDAY: click h·ªôp qu√† -> chuy·ªÉn sang scene GALAXY ===== */
(function(){
  const giftWrap  = document.getElementById('giftWrap');
  const giftEmoji = document.getElementById('giftEmoji');

  function goNext(){
    // L∆∞u l·ªùi ch√∫c qua galaxy
    const greet = localStorage.getItem(LS_GREETING)
      || "Ch√∫c m·ª´ng sinh nh·∫≠t üéÇ Ch√∫c b·∫°n lu√¥n xinh ƒë·∫πp, h·∫°nh ph√∫c v√† ƒë∆∞·ª£c y√™u th∆∞∆°ng nh·∫•t v≈© tr·ª• üíñ‚ú®";
    localStorage.setItem("wish_text", greet);

    // hi·ªáu ·ª©ng m·ªü n·∫Øp h·ªôp
    giftEmoji.classList.add('open');

    // ·∫®n scene birthday, hi·ªán galaxy
    setTimeout(()=>{
      const sceneBirthday = document.getElementById('scene-birthday');
      if (sceneBirthday) sceneBirthday.style.display = 'none';

      // N·ªÅn ƒëen cho galaxy (th√™m ƒë·ªÉ chuy·ªÉn m∆∞·ª£t)
      document.body.style.background = '#000';

      const sceneGalaxy = document.getElementById('scene-galaxy');
      if (sceneGalaxy) sceneGalaxy.style.display = 'block';
    }, 600);
  }

  giftEmoji.addEventListener('click', goNext);
  giftWrap.addEventListener('click', goNext);
})();
</script>

<script>
/* =========================================================
   ========== GALAXY: NEON HEART + CSS CAROUSEL ============
   ========================================================= */

/* L·ªùi ch√∫c tr√™n c√πng: g√µ t·ª´ng ch·ªØ + xong m·ªõi hi·ªán LED */
/* L·ªùi ch√∫c galaxy: "Ch√∫c m·ª´ng sinh nh·∫≠t b·∫°n iu üíñ" r∆°i t·ª´ng ch·ªØ + xong m·ªõi hi·ªán LED */
const wishEl = document.getElementById('wishBox');

// Default l·ªùi ch√∫c n·∫øu settings ch∆∞a l∆∞u g√¨
const savedWish = localStorage.getItem('wish_text')
  || "Ch√∫c m·ª´ng sinh nh·∫≠t b·∫°n iu üíñ";

// Reset n·ªôi dung
wishEl.innerHTML = "";
let twIndex = 0;

function typeWriterDrop() {
  if (twIndex < savedWish.length) {
    const ch = savedWish.charAt(twIndex);

    const span = document.createElement('span');
    span.textContent = ch;
    span.className = 'wish-ch';
    // m·ªói ch·ªØ l·ªách nh·∫π th·ªùi gian 1 ch√∫t cho gi·ªëng m∆∞a ch·ªØ
    span.style.animationDelay = '0s';

    wishEl.appendChild(span);
    twIndex++;

    setTimeout(typeWriterDrop, 70); // t·ªëc ƒë·ªô xu·∫•t hi·ªán t·ª´ng ch·ªØ
  } else {
    // G√µ / r∆°i xong to√†n b·ªô -> hi·ªán LED
    const led = document.querySelector('.led');
    if (led) {
      led.classList.add('show');
    }
  }
}

// B·∫Øt ƒë·∫ßu: cho wishBox hi·ªán m·ªù r·ªìi r∆°i ch·ªØ
setTimeout(() => {
  wishEl.style.opacity = 1;
  typeWriterDrop();
}, 900);

/* ƒêo path tr√°i tim neon ƒë·ªÉ LED ch·∫°y */
function setupNeonHeart(){
  const neonPaths = document.querySelectorAll('#scene-galaxy .neon-layer path.neon');
  neonPaths.forEach(p=>{
    try{
      const L = Math.ceil(p.getTotalLength());
      p.style.setProperty('--len', L);
      p.style.strokeDasharray  = L;
      p.style.strokeDashoffset = L;
    }catch(e){}
  });
}

/* IndexedDB helpers cho galaxy (·∫£nh l·∫•y t·ª´ settings nh∆∞ c≈©) */
const DB_NAME = 'birthdayDB';
const DB_VER  = 1;
const STORE   = 'images';

function openDBG() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = () => {
      const db = req.result;
      if (!db.objectStoreNames.contains(STORE)) {
        db.createObjectStore(STORE);
      }
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror   = () => reject(req.error);
  });
}

async function getImageFromDB(key) {
  const db = await openDBG();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE, 'readonly');
    const req = tx.objectStore(STORE).get(key);
    req.onsuccess = () => resolve(req.result || null);
    req.onerror   = () => reject(req.error);
  });
}

async function loadAllGalaxyImages() {
  const keys = [
    'img_galaxy_1',
    'img_galaxy_2',
    'img_galaxy_3',
    'img_galaxy_4',
    'img_galaxy_5'
  ];
  const urls = [];
  for (const k of keys) {
    const blob = await getImageFromDB(k);
    if (blob) urls.push(URL.createObjectURL(blob));
  }
  if (urls.length === 0) {
    urls.push('assets/cute-cake.png');
  }
  return urls;
}

/* Carousel logic */
let carouselEl = null;
let cards = [];

function centerAll(){
  if (!cards.length) return;
  cards.forEach(c=>{
    c.style.transitionTimingFunction = 'cubic-bezier(.2,.7,.2,1)';
    c.style.transform = 'translate(-50%, -50%) translateZ(0px) rotateY(0deg) scale(.9)';
  });
  if (carouselEl){
    carouselEl.style.opacity = '0';
    carouselEl.style.pointerEvents = 'none';
  }
}

function fanOut(){
  if (!cards.length || !carouselEl) return;
  const ring = getComputedStyle(document.documentElement).getPropertyValue('--ringZ').trim() || '300px';
  const n = cards.length;
  cards.forEach((c, idx)=>{
    const angle = +c.dataset.angle || (idx * (360/n));
    c.style.transitionTimingFunction = 'cubic-bezier(.18,.88,.18,1)';
    setTimeout(()=>{
      c.style.transform = `translate(-50%, -50%) rotateY(${angle}deg) translateZ(${ring}) rotateX(-6deg)`;
    }, idx * 140);
  });

  const liaDuration = 140 * n + 400;
  setTimeout(()=>{
    carouselEl.style.opacity = '1';
    carouselEl.style.pointerEvents = 'auto';
  }, liaDuration);
}

function startSpin(){
  if (carouselEl) carouselEl.classList.add('spinning');
}

/* T·∫°o card t·ª´ list URL (·∫£nh t·ª´ settings) */
function buildCarousel(urls){
  carouselEl = document.getElementById('carousel');
  if (!carouselEl) return;
  carouselEl.innerHTML = '';

  const n = urls.length || 1;
  urls.forEach((url, idx)=>{
    const card = document.createElement('div');
    card.classList.add('card');
    if (idx % 3 === 0) card.classList.add('glow-pink');
    else if (idx % 3 === 1) card.classList.add('glow-cyan');
    else card.classList.add('pulse');

    const angle = idx * (360 / n);
    card.dataset.angle = angle.toString();

    const imgDiv = document.createElement('div');
    imgDiv.className = 'img';
    imgDiv.style.backgroundImage = `url("${url}")`;

    card.appendChild(imgDiv);
    carouselEl.appendChild(card);
  });

  cards = Array.from(carouselEl.querySelectorAll('.card'));

  // Flow: gom v·ªÅ gi·ªØa -> fan-out -> b·∫Øt ƒë·∫ßu quay
  centerAll();
  setTimeout(()=>{
    fanOut();
    const totalDelay = 140 * cards.length + 1200;
    setTimeout(startSpin, totalDelay);
  }, 600);
}

/* Kh·ªüi t·∫°o galaxy */
async function initGalaxy(){
  setupNeonHeart();
  const urls = await loadAllGalaxyImages();
  buildCarousel(urls);
}

window.addEventListener('load', initGalaxy);
</script>

<script>
/* ================== GALAXY BACKGROUND CANVAS ================== */

const cv = document.getElementById('cv');
const cx = cv.getContext('2d', { alpha: false });

let dprG = Math.min(window.devicePixelRatio || 1, 2);

function resizeGalaxyCanvas(){
  const w = window.innerWidth;
  const h = window.innerHeight;
  cv.width  = Math.max(1, Math.floor(w * dprG));
  cv.height = Math.max(1, Math.floor(h * dprG));
  cv.style.width  = w + 'px';
  cv.style.height = h + 'px';
  cx.setTransform(dprG,0,0,dprG,0,0);
}
window.addEventListener('resize', resizeGalaxyCanvas);
resizeGalaxyCanvas();

/* Sao xa + ƒëi·ªÉm ng√¢n h√† */
const STAR_COUNT   = 600;
const GAL_COUNT    = 2200;
const GAL_RADIUS   = 420;
const GAL_THICK    = 80;

const stars = [];
const gals  = [];

function initStars(){
  stars.length = 0;
  for(let i=0;i<STAR_COUNT;i++){
    stars.push({
      x: (Math.random()-0.5) * 2 * window.innerWidth,
      y: (Math.random()-0.5) * 2 * window.innerHeight,
      baseAlpha: 0.25 + Math.random()*0.55,
      tw: Math.random()*2*Math.PI,
      twSpeed: 0.004 + Math.random()*0.004,
      r: 0.6 + Math.random()*1.2
    });
  }
}

function initGalaxyPoints(){
  gals.length = 0;
  for(let i=0;i<GAL_COUNT;i++){
    const t = Math.random();
    const r = Math.pow(t,0.55) * GAL_RADIUS;
    const baseAngle = Math.random() * Math.PI * 2;
    const swirl = r * 0.2;
    const a = baseAngle + swirl;

    const x = Math.cos(a) * r;
    const y = (Math.random()-0.5) * GAL_THICK * (0.3 + 0.7 * (r/GAL_RADIUS));
    const z = Math.sin(a) * r;

    const armHue = 200 + (a/(Math.PI*2))*120;
    const light  = 55 + Math.random()*12;

    gals.push({
      x,y,z,
      baseAngle:a,
      radius:r,
      hue:armHue,
      light,
      size:0.35 + Math.random()*1.1,
      speed:0.0008 + Math.random()*0.0012
    });
  }
}

initStars();
initGalaxyPoints();

let tGal = 0;

function renderGalaxy(){
  requestAnimationFrame(renderGalaxy);
  tGal += 1;

  const w = window.innerWidth;
  const h = window.innerHeight;
  const cxMid = w/2;
  const cyMid = h/2;

  // n·ªÅn t·ªëi + h∆°i t√≠m
  const bg = cx.createRadialGradient(cxMid, cyMid*0.8, 0, cxMid, cyMid, Math.max(w,h));
  bg.addColorStop(0,'rgba(8,8,20,1)');
  bg.addColorStop(0.5,'rgba(2,5,25,1)');
  bg.addColorStop(1,'rgba(0,0,0,1)');
  cx.fillStyle = bg;
  cx.fillRect(0,0,w,h);

  // sao xa twinkle
  for(const s of stars){
    s.tw += s.twSpeed;
    const alpha = s.baseAlpha * (0.6 + 0.4*Math.sin(s.tw));
    cx.globalAlpha = alpha;
    cx.beginPath();
    cx.arc(cxMid + s.x*0.5, cyMid + s.y*0.5, s.r, 0, Math.PI*2);
    cx.fillStyle = '#ffffff';
    cx.fill();
  }
  cx.globalAlpha = 1;

  // glow l√µi galaxy
  const core = cx.createRadialGradient(cxMid, cyMid, 0, cxMid, cyMid, GAL_RADIUS*0.9);
  core.addColorStop(0,'rgba(255,255,255,0.95)');
  core.addColorStop(0.2,'rgba(220,210,255,0.85)');
  core.addColorStop(0.45,'rgba(150,120,255,0.55)');
  core.addColorStop(0.9,'rgba(20,10,40,0.0)');
  cx.fillStyle = core;
  cx.beginPath();
  cx.arc(cxMid, cyMid, GAL_RADIUS, 0, Math.PI*2);
  cx.fill();

  // ƒëi·ªÉm ng√¢n h√† xo√°y
  for(const p of gals){
    const a = p.baseAngle + tGal * p.speed;
    const r = p.radius * (0.96 + 0.08*Math.sin(tGal*0.01 + p.radius*0.02));

    const sx = cxMid + Math.cos(a) * r;
    const sy = cyMid + Math.sin(a) * r * 0.55 + (p.y*0.2);

    const flicker = 0.7 + 0.3*Math.sin((tGal*0.03) + p.radius*0.05);
    const size = p.size * flicker;
    const hue = (p.hue + 10*Math.sin(tGal*0.01)) % 360;

    cx.beginPath();
    cx.fillStyle = `hsla(${hue}, 80%, ${p.light}%, 0.9)`;
    cx.arc(sx, sy, size, 0, Math.PI*2);
    cx.fill();
  }
}

renderGalaxy();
</script>

</body>
</html>

