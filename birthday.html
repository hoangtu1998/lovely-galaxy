<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Birthday ‚ú®</title>

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Playpen+Sans:wght@400;700&display=swap" rel="stylesheet">

  <meta name="theme-color" content="#ffd9e8">

  <style>
    *{box-sizing:border-box;margin:0;padding:0;}
    html,body{height:100%;}
    body{
      overflow:hidden;
      color:#fff;
      font-family:"Playpen Sans",sans-serif;
      background:
        radial-gradient(circle at 50% 30%,
          rgba(255,170,200,1) 0%,
          rgba(255,120,180,1) 40%,
          rgba(90,0,60,1) 100%);
      background-color:#ff7ab4;
    }

    #pinkBg{
      position:fixed;
      inset:0;
      background:linear-gradient(180deg,#ffc0cb 0%,#ff99cc 50%,#ff66b2 100%);
      z-index:-1;
      pointer-events:none;
      user-select:none;
    }

    .bgLayerImg{
      position:fixed; inset:0; z-index:0; pointer-events:none; user-select:none;
      background: linear-gradient(rgba(255,170,200,0.4),rgba(255,120,180,0.5)), url("assets/cute-cake.png");
      background-position:center; background-size:cover; background-repeat:no-repeat; background-attachment:fixed;
      filter:saturate(1.2) brightness(1.05);
    }

    #matrix,#fireworks,#cuteLayer{
      position:fixed; inset:0; pointer-events:none;
    }
    #matrix{ z-index:1; }
    #fireworks{ z-index:2; }
    #cuteLayer{ z-index:3; }

    /* ====== CH·ªÆ R∆†I ·ªû GI·ªÆA (spacing m·ªõi) ====== */
.rainAllWrap{
  position:fixed;
  left:50%; top:50%;
  transform:translate(-50%,-60%);
  z-index:5;
  width:100%;
  max-width:90vw;
  text-align:center;
  pointer-events:none;
}

/* m·ªói d√≤ng c√°ch nhau xa h∆°n */
.rainWrap{
  opacity:0;
  margin-bottom: clamp(24px, 4vw, 42px); /* tƒÉng line spacing */
}
.rainWrap.show{opacity:1;}

.rain{
  display:inline-block;
  font-weight:700;
  font-size:clamp(20px,3.5vw,42px);
  color:#ff2b2b;
  text-shadow:
    0 0 10px rgba(255,50,80,0.9),
    0 0 24px rgba(255,0,70,0.8),
    0 3px 8px rgba(0,0,0,0.6);
  font-family:"Dancing Script",cursive;

  /* === spacing m·ªõi, ƒë·ªÅu & tho√°ng h∆°n === */
  line-height:1.2;
  letter-spacing: clamp(0.10em, 0.6vw, 0.24em);
  word-spacing:   clamp(0.12em, 0.8vw, 0.28em);
}

/* H√†ng 29+ d√πng font kh√°c ‚Üí cho gi√£n nh·∫π th√™m ƒë·ªÉ c√¢n */
.line3 .rain{
  font-family:"Playpen Sans",sans-serif;
  font-size:clamp(22px,3.2vw,38px);
  color:#ff2b2b; font-weight:700;
  text-shadow:
    0 0 8px rgba(255,60,90,0.9),
    0 0 22px rgba(255,20,70,0.7),
    0 3px 8px rgba(0,0,0,0.6);

  /* spacing ri√™ng cho h√†ng s·ªë */
  letter-spacing: clamp(0.12em, 0.7vw, 0.26em);
  word-spacing:   clamp(0.14em, 0.9vw, 0.30em);
}

/* ƒê·ªám nh·ªè gi·ªØa t·ª´ng k√Ω t·ª± r∆°i ƒë·ªÉ nh√¨n c√¢n m·∫Øt h∆°n */
.drop{
  display:inline-block;
  opacity:0;
  transform:translateY(-40px);

  /* tƒÉng nh·∫π t·ª´ 0.02em l√™n 0.06em */
  margin-right: 0.06em;
}
@keyframes dropIn{
  0%{opacity:0;transform:translateY(-40px);}
  60%{opacity:1;transform:translateY(8px);}
  80%{transform:translateY(-4px);}
  100%{opacity:1;transform:translateY(0);}
}
.drop.animate{animation:dropIn 1.8s ease-out forwards;}

/* Nh·ªè m√†n h√¨nh: thu b·ªõt spacing ƒë·ªÉ kh√¥ng b·ªã tr√†n */
@media (max-width: 390px){
  .rain{ letter-spacing: 0.10em; word-spacing: 0.14em; }
  .line3 .rain{ letter-spacing: 0.12em; word-spacing: 0.16em; }
  .drop{ margin-right: 0.04em; }
}


    /* ====== H·ªòP QU√Ä D∆Ø·ªöI ====== */
    .giftWrap{
      position:fixed; left:0; right:0; bottom:12vh;
      display:grid; place-items:center;
      z-index:6; text-align:center;

      /* ·∫®N l√∫c ƒë·∫ßu ‚Äì ch·ªâ SHOW sau khi ch·ªØ r∆°i xong */
      opacity:0;
      transform:translateY(10px) scale(.98);
      pointer-events:none;
      transition: opacity .6s ease, transform .6s ease;
    }
    .giftWrap.show{
      opacity:1;
      transform:translateY(0) scale(1);
      pointer-events:auto;
    }

    .giftEmoji{
      position:relative;
      font-size:clamp(80px,12vw,130px);
      line-height:1;
      cursor:pointer;
      display:inline-block;
      animation:shake 1s infinite;
      transform-origin:center bottom;
      filter:drop-shadow(0 4px 8px rgba(0,0,0,.8));
    }
    .giftText{
      position:absolute; top:60%; left:50%; transform:translate(-50%,-50%);
      color:#fff; font-size:clamp(20px,3vw,28px); font-weight:700;
      text-shadow:0 2px 6px rgba(0,0,0,.7);
      pointer-events:none; line-height:1.2; text-align:center;
      font-family:"Playpen Sans",sans-serif;
    }
    .giftEmoji.open{animation:none;}
    .giftEmoji::before{
      content:"üéÅ"; position:absolute; left:0;right:0;top:0; text-align:center;
      font-size:inherit; line-height:1; transform-origin:center bottom; pointer-events:none; opacity:0;
    }
    .giftEmoji.open::before{
      opacity:1; animation:lidFlip .6s ease-out forwards;
      filter:drop-shadow(0 8px 12px rgba(255,105,180,.7));
    }
    @keyframes lidFlip{
      0%{transform:translateY(0) rotateX(0deg) scale(1);}
      60%{transform:translateY(-40px) rotateX(70deg) scale(1.05);}
      100%{transform:translateY(-60px) rotateX(110deg) scale(1.05);}
    }
    @keyframes shake{
      0%,100% { transform: translateY(0) rotate(0deg) scale(1); }
      10%     { transform: translateY(-4px) rotate(-4deg) scale(1.03); }
      20%     { transform: translateY(2px) rotate(3deg) scale(1.04); }
      30%     { transform: translateY(-6px) rotate(-6deg) scale(1.05); }
      40%     { transform: translateY(3px) rotate(4deg) scale(1.03); }
      50%     { transform: translateY(-8px) rotate(-4deg) scale(1.06); }
      60%     { transform: translateY(4px) rotate(4deg) scale(1.03); }
      70%     { transform: translateY(-5px) rotate(-3deg) scale(1.05); }
      80%     { transform: translateY(2px) rotate(2deg) scale(1.02); }
      90%     { transform: translateY(-3px) rotate(-2deg) scale(1.03); }
    }

    canvas{image-rendering:pixelated;}
  </style>
</head>
<body>

  <div id="pinkBg"></div>
  <div class="bgLayerImg" id="bgLayerDynamic"></div>

  <canvas id="matrix"></canvas>
  <canvas id="fireworks"></canvas>
  <canvas id="cuteLayer"></canvas>

  <!-- ch·ªØ -->
  <div class="rainAllWrap">
    <div class="rainWrap line1" aria-hidden="true">
      <div class="rain">
        <span class="drop">C</span><span class="drop">H</span><span class="drop">√ö</span><span class="drop">C</span><span class="drop">&nbsp;</span>
        <span class="drop">M</span><span class="drop">·ª™</span><span class="drop">N</span><span class="drop">G</span><span class="drop">&nbsp;</span>
        <span class="drop">S</span><span class="drop">I</span><span class="drop">N</span><span class="drop">H</span><span class="drop">&nbsp;</span>
        <span class="drop">N</span><span class="drop">H</span><span class="drop">·∫¨</span><span class="drop">T</span><span class="drop">!</span>
      </div>
    </div>

    <div class="rainWrap line2" aria-hidden="true">
      <div class="rain">
        <span class="drop">B</span><span class="drop">·∫°</span><span class="drop">n</span><span class="drop">&nbsp;</span>
        <span class="drop">i</span><span class="drop">u</span>
      </div>
    </div>

    <div class="rainWrap line3" aria-hidden="true">
      <div class="rain">
        <span class="drop">2</span><span class="drop">9</span><span class="drop">+</span>
      </div>
    </div>
  </div>

  <!-- h·ªôp qu√† (·∫©n tr∆∞·ªõc, ch·ªâ show sau khi ch·ªØ xong) -->
  <div class="giftWrap" id="giftWrap">
    <div class="giftEmoji" id="giftEmoji">
      üéÅ
      <div class="giftText">M·ªü qu√†</div>
    </div>
  </div>

<script>
/* KEYS */
const LS_IMG_BIRTH_TOP  = 'img_birthday_top_dataurl';
const LS_GREETING       = 'greeting_text';

/* ===== ƒë·ªïi n·ªÅn birthday_top n·∫øu c√≥ ===== */
(function applyBirthdayTopBackground(){
  const bgLayer = document.getElementById("bgLayerDynamic");
  const topImg = localStorage.getItem(LS_IMG_BIRTH_TOP);
  if (topImg) {
    bgLayer.style.background =
      `linear-gradient(rgba(255,170,200,0.4),rgba(255,120,180,0.5)),url("${topImg}")`;
    bgLayer.style.backgroundPosition = "center";
    bgLayer.style.backgroundSize = "cover";
    bgLayer.style.backgroundRepeat = "no-repeat";
    bgLayer.style.backgroundAttachment = "fixed";
    bgLayer.style.filter = "saturate(1.2) brightness(1.05)";
  }
})();

/* ===== hi·ªáu ·ª©ng ch·ªØ r∆°i l·∫ßn l∆∞·ª£t ===== */
function playLine(lineElem, callback){
  lineElem.classList.add('show');
  const letters = lineElem.querySelectorAll('.drop');
  letters.forEach((span, idx) => {
    const delay = 0.1 * (idx + 1);
    span.style.animationDelay = delay + 's';
    span.classList.add('animate');
  });
  const totalMs = (0.1 * letters.length + 1.8) * 1000; // 1.8s anim + delay chu·ªói
  setTimeout(() => { if (callback) callback(); }, totalMs);
}

const line1 = document.querySelector('.rainWrap.line1');
const line2 = document.querySelector('.rainWrap.line2');
const line3 = document.querySelector('.rainWrap.line3');

const giftWrap = document.getElementById('giftWrap');

playLine(line1, () => {
  playLine(line2, () => {
    playLine(line3, () => {
      // >>> Ch·ªâ khi to√†n b·ªô 3 d√≤ng r∆°i xong m·ªõi show h·ªôp qu√†
      giftWrap.classList.add('show');
    });
  });
});

/* ===== matrix text background ===== */
const cvs = document.getElementById('matrix');
const ctx = cvs.getContext('2d');
const glyphs = 'HappyBirthdayüéÇ‚ú®';
let W,H,cols,drops,DPR;
function resizeMatrix(){
  DPR = Math.max(1, window.devicePixelRatio || 1);
  W = cvs.width = Math.floor(innerWidth * DPR);
  H = cvs.height = Math.floor(innerHeight * DPR);
  cvs.style.width = innerWidth + 'px';
  cvs.style.height = innerHeight + 'px';
  ctx.setTransform(DPR,0,0,DPR,0,0);
  const step = 22;
  cols = Math.floor(innerWidth / step);
  drops = Array(cols).fill(0);
}
addEventListener('resize', resizeMatrix);
resizeMatrix();
(function drawMatrix(){
  requestAnimationFrame(drawMatrix);
  ctx.clearRect(0,0,innerWidth,innerHeight);
  const step = 22;
  ctx.font = 'bold 18px monospace';
  ctx.globalCompositeOperation = 'source-over';
  for(let i=0;i<drops.length;i++){
    const ch = glyphs[Math.floor(Math.random()*glyphs.length)];
    const x = i*step;
    const y = drops[i]*step;
    ctx.lineWidth = 3;
    ctx.strokeStyle = 'rgba(255,255,255,0.8)';
    ctx.strokeText(ch, x, y);
    ctx.shadowColor = 'rgba(255,105,180,.8)';
    ctx.shadowBlur = 12;
    ctx.fillStyle = '#fff';
    ctx.fillText(ch, x, y);
    ctx.shadowBlur = 0;
    if (y > H && Math.random() > 0.97) { drops[i] = 0; } else { drops[i] += 0.5; }
  }
})();

/* ===== ph√°o hoa ===== */
const fwCanvas = document.getElementById('fireworks');
const fwCtx = fwCanvas.getContext('2d');
let fwW, fwH, fireworks=[], particles=[];
function resizeFW(){ fwW = fwCanvas.width = innerWidth; fwH = fwCanvas.height = innerHeight; }
addEventListener('resize', resizeFW); resizeFW();

class Firework {
  constructor(){ this.x=Math.random()*fwW; this.y=fwH; this.tx=Math.random()*fwW; this.ty=Math.random()*fwH*0.4+fwH*0.1;
    this.vx=(this.tx-this.x)/30; this.vy=(this.ty-this.y)/30; this.life=30;
    const rainbow=['#ff3366','#ff9933','#ffff33','#33ff66','#33ccff','#9966ff','#ff33cc'];
    this.color=rainbow[Math.floor(Math.random()*rainbow.length)];
  }
  update(){ this.x+=this.vx; this.y+=this.vy; this.life--; if(this.life<=0){ explode(this.x,this.y); return false;} return true; }
  draw(){ fwCtx.beginPath(); fwCtx.fillStyle=this.color; fwCtx.arc(this.x,this.y,2,0,Math.PI*2); fwCtx.fill(); }
}
class Particle {
  constructor(x,y){ const angle=Math.random()*Math.PI*2; const speed=Math.random()*3+1;
    this.x=x; this.y=y; this.vx=Math.cos(angle)*speed; this.vy=Math.sin(angle)*speed;
    this.alpha=1; this.decay=Math.random()*0.02+0.015;
    const rainbow=['#ff3366','#ff9933','#ffff33','#33ff66','#33ccff','#9966ff','#ff33cc'];
    this.color=rainbow[Math.floor(Math.random()*rainbow.length)];
  }
  update(){ this.x+=this.vx; this.y+=this.vy; this.vy+=0.03; this.alpha-=this.decay; return this.alpha>0; }
  draw(){ fwCtx.globalAlpha=this.alpha; fwCtx.beginPath(); fwCtx.fillStyle=this.color; fwCtx.arc(this.x,this.y,2,0,Math.PI*2); fwCtx.fill(); fwCtx.globalAlpha=1; }
}
function explode(x,y){ for(let i=0;i<40;i++){ particles.push(new Particle(x,y)); } }
function loopFW(){
  requestAnimationFrame(loopFW);
  fwCtx.clearRect(0,0,fwW,fwH);
  if(Math.random()<0.08){ fireworks.push(new Firework()); }
  fireworks = fireworks.filter(fw=>{ const alive=fw.update(); fw.draw(); return alive; });
  particles = particles.filter(p=>{ const alive=p.update(); p.draw(); return alive; });
}
loopFW();

/* ===== tuy·∫øt + tim ===== */
const cuteCanvas = document.getElementById('cuteLayer');
const cuteCtx = cuteCanvas.getContext('2d');
let cW, cH, snowflakes=[], critters=[];
const ENABLE_SNOW = true, ENABLE_CRITTERS = true;

function resizeCute(){ cW = cuteCanvas.width = innerWidth; cH = cuteCanvas.height = innerHeight; }
addEventListener('resize', resizeCute); resizeCute();

function initSnow(){
  snowflakes = [];
  for(let i=0;i<50;i++){
    snowflakes.push({ x:Math.random()*cW, y:Math.random()*cH, r:Math.random()*3+3, spdY:Math.random()*1+0.8, drift:(Math.random()*1-0.5) });
  }
}
function initCritters(){
  critters = [];
  const EMOJIS = ['üíñ','üíñ','üíñ','üíñ','üíñ','üíñ'];
  for(let i=0;i<6;i++){
    critters.push({ emoji:EMOJIS[i%EMOJIS.length], x:Math.random()*cW, y:Math.random()*cH, vx:(Math.random()<0.5?-1:1)*(1.5+Math.random()*1.5), vy:(Math.random()<0.5?-1:1)*(1.5+Math.random()*1.5), size:28+Math.random()*8 });
  }
}
if(ENABLE_SNOW) initSnow();
if(ENABLE_CRITTERS) initCritters();

function loopCute(){
  requestAnimationFrame(loopCute);
  cuteCtx.clearRect(0,0,cW,cH);

  if(ENABLE_SNOW){
    cuteCtx.fillStyle = "#fff";
    for(const f of snowflakes){
      f.y += f.spdY; f.x += f.drift;
      if(f.y > cH){ f.y = -10; f.x = Math.random()*cW; }
      cuteCtx.beginPath(); cuteCtx.globalAlpha = 0.9; cuteCtx.arc(f.x,f.y,f.r,0,Math.PI*2); cuteCtx.fill();
    }
    cuteCtx.globalAlpha = 1;
  }

  if(ENABLE_CRITTERS){
    for(const c of critters){
      c.x += c.vx; c.y += c.vy;
      if(c.x < 20){ c.x = 20; c.vx *= -1; }
      if(c.x > cW-20){ c.x = cW-20; c.vx *= -1; }
      if(c.y < 20){ c.y = 20; c.vy *= -1; }
      if(c.y > cH-20){ c.y = cH-20; c.vy *= -1; }

      cuteCtx.save();
      cuteCtx.translate(c.x, c.y);
      if(c.vx < 0){ cuteCtx.scale(-1,1); }
      cuteCtx.font = `${c.size}px "Segoe UI Emoji","Apple Color Emoji","Noto Color Emoji",sans-serif`;
      cuteCtx.textAlign = "center";
      cuteCtx.textBaseline = "middle";
      cuteCtx.fillText(c.emoji,0,0);
      cuteCtx.restore();
    }
  }
  cuteCtx.globalAlpha = 1;
}
loopCute();

/* ===== click m·ªü qu√† ===== */
const gift = document.getElementById('giftEmoji');
gift.addEventListener('click', () => {
  gift.classList.add('open');

  const greet = localStorage.getItem(LS_GREETING)
    || "Ch√∫c m·ª´ng sinh nh·∫≠t üéÇ Ch√∫c b·∫°n lu√¥n xinh ƒë·∫πp, h·∫°nh ph√∫c v√† ƒë∆∞·ª£c y√™u th∆∞∆°ng nh·∫•t v≈© tr·ª• üíñ‚ú®";
  localStorage.setItem("wish_text", greet);

  setTimeout(() => { location.href = 'galaxy_2.html'; }, 600);
});
</script>
  <!-- === BGM Player (Birthday) ‚Äî START === -->
<!-- Background music -->
<audio id="bgm" preload="auto" loop playsinline style="display:none"></audio>
<script>
(async () => {
  const DEFAULT_BGM_URL = 'hpbd.mp3'; // file nh·∫°c m·∫∑c ƒë·ªãnh c·ªßa b·∫°n
  const KEY_BGM = 'bgm_blob';
  const audio = document.getElementById('bgm');
  audio.volume = 0.4;

  // IndexedDB get
  function openDB(){
    return new Promise((resolve,reject)=>{
      const req = indexedDB.open('birthdayDB',1);
      req.onsuccess=()=>resolve(req.result);
      req.onupgradeneeded=()=>req.result.createObjectStore('images');
      req.onerror=()=>reject(req.error);
    });
  }
  async function dbGet(key){
    const db = await openDB();
    return new Promise((resolve,reject)=>{
      const tx=db.transaction('images','readonly');
      const req=tx.objectStore('images').get(key);
      req.onsuccess=()=>resolve(req.result||null);
      req.onerror=()=>reject(req.error);
    });
  }

  // ∆∞u ti√™n nh·∫°c user
  const blob = await dbGet(KEY_BGM);
  if(blob){
    const url = URL.createObjectURL(blob);
    audio.src = url;
  } else {
    audio.src = DEFAULT_BGM_URL;
  }

  // auto play (d·ª±a tr√™n pass from index)
  const allowed = sessionStorage.getItem('allow_music')==='1';
  sessionStorage.removeItem('allow_music');

  const tryPlay = ()=>audio.play().catch(()=>{
    const kick = ()=>audio.play();
    window.addEventListener('pointerdown',kick,{once:true});
    window.addEventListener('keydown',kick,{once:true});
  });

  if(allowed) tryPlay();
})();
</script>

</body>
</html>



