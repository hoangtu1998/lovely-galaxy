<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>Birthday ‚ú®</title>
  <meta name="theme-color" content="#000000">

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Playpen+Sans:wght@400;700&display=swap" rel="stylesheet">

  <style>
    *{box-sizing:border-box;margin:0;padding:0;}
    html,body{height:100%;}
    body{
      overflow:hidden;
      color:#fff;
      font-family:"Playpen Sans",sans-serif;
      background:
        radial-gradient(circle at 50% 30%,
          rgba(255,170,200,1) 0%,
          rgba(255,120,180,1) 40%,
          rgba(90,0,60,1) 100%);
      background-color:#ff7ab4;
    }

    /* ===== SCENE 1: BIRTHDAY ===== */

    #pinkBg{
      position:fixed;
      inset:0;
      background:linear-gradient(180deg,#ffc0cb 0%,#ff99cc 50%,#ff66b2 100%);
      z-index:-1;
      pointer-events:none;
      user-select:none;
    }

    .bgLayerImg{
      position:fixed; inset:0; z-index:0; pointer-events:none; user-select:none;
      background: linear-gradient(rgba(255,170,200,0.4),rgba(255,120,180,0.5)), url("assets/cute-cake.png");
      background-position:center; background-size:cover; background-repeat:no-repeat; background-attachment:fixed;
      filter:saturate(1.2) brightness(1.05);
    }

    #matrix,#fireworks,#cuteLayer{
      position:fixed; inset:0; pointer-events:none;
    }
    #matrix{ z-index:1; }
    #fireworks{ z-index:2; }
    #cuteLayer{ z-index:3; }

    /* ch·ªØ r∆°i */
    .rainAllWrap{
      position:fixed;
      left:50%; top:50%;
      transform:translate(-50%,-60%);
      z-index:5;
      width:100%;
      max-width:90vw;
      text-align:center;
      pointer-events:none;
    }

    .rainWrap{
      opacity:0;
      margin-bottom: clamp(32px, 4vw, 42px);
    }
    .rainWrap.show{opacity:1;}

    .rain{
      display:inline-block;
      font-weight:700;
      font-size:clamp(24px,3.5vw,42px);
      color:#ff2b2b;
      text-shadow:
        0 0 10px rgba(255,50,80,0.9),
        0 0 24px rgba(255,0,70,0.8),
        0 3px 8px rgba(0,0,0,0.6);
      font-family:"Dancing Script",cursive;
    }

    .line3 .rain{
      font-family:"Playpen Sans",sans-serif;
      font-size:clamp(22px,3.2vw,38px);
      color:#ff2b2b; font-weight:700;
      text-shadow:
        0 0 8px rgba(255,60,90,0.9),
        0 0 22px rgba(255,20,70,0.7),
        0 3px 8px rgba(0,0,0,0.6);
    }

    .drop{
      display:inline-block;
      opacity:0;
      transform:translateY(-40px);
      margin-right: 0.01em;
    }
    @keyframes dropIn{
      0%{opacity:0;transform:translateY(-40px);}
      60%{opacity:1;transform:translateY(8px);}
      80%{transform:translateY(-4px);}
      100%{opacity:1;transform:translateY(0);}
    }
    .drop.animate{animation:dropIn 1.8s ease-out forwards;}

    @media (max-width: 390px){
      .rain{ letter-spacing: 0.10em; word-spacing: 0.14em; }
      .line3 .rain{ letter-spacing: 0.12em; word-spacing: 0.16em; }
      .drop{ margin-right: 0.04em; }
    }

    .giftWrap{
      position:fixed; left:0; right:0; bottom:12vh;
      display:grid; place-items:center;
      z-index:6; text-align:center;
      opacity:0;
      transform:translateY(10px) scale(.98);
      pointer-events:none;
      transition: opacity .6s ease, transform .6s ease;
    }
    .giftWrap.show{
      opacity:1;
      transform:translateY(0) scale(1);
      pointer-events:auto;
    }

    .giftEmoji{
      position:relative;
      font-size:clamp(80px,12vw,130px);
      line-height:1;
      cursor:pointer;
      display:inline-block;
      animation:shake 1s infinite;
      transform-origin:center bottom;
      filter:drop-shadow(0 4px 8px rgba(0,0,0,.8));
    }
    .giftText{
      position:absolute; top:60%; left:50%; transform:translate(-50%,-50%);
      color:#fff; font-size:clamp(20px,3vw,28px); font-weight:700;
      text-shadow:0 2px 6px rgba(0,0,0,.7);
      pointer-events:none; line-height:1.2; text-align:center;
      font-family:"Playpen Sans",sans-serif;
    }
    .giftEmoji.open{animation:none;}
    .giftEmoji::before{
      content:"üéÅ"; position:absolute; left:0;right:0;top:0; text-align:center;
      font-size:inherit; line-height:1; transform-origin:center bottom; pointer-events:none; opacity:0;
    }
    .giftEmoji.open::before{
      opacity:1; animation:lidFlip .6s ease-out forwards;
      filter:drop-shadow(0 8px 12px rgba(255,105,180,.7));
    }
    @keyframes lidFlip{
      0%{transform:translateY(0) rotateX(0deg) scale(1);}
      60%{transform:translateY(-40px) rotateX(70deg) scale(1.05);}
      100%{transform:translateY(-60px) rotateX(110deg) scale(1.05);}
    }
    @keyframes shake{
      0%,100% { transform: translateY(0) rotate(0deg) scale(1); }
      10%     { transform: translateY(-4px) rotate(-4deg) scale(1.03); }
      20%     { transform: translateY(2px) rotate(3deg) scale(1.04); }
      30%     { transform: translateY(-6px) rotate(-6deg) scale(1.05); }
      40%     { transform: translateY(3px) rotate(4deg) scale(1.03); }
      50%     { transform: translateY(-8px) rotate(-4deg) scale(1.06); }
      60%     { transform: translateY(4px) rotate(4deg) scale(1.03); }
      70%     { transform: translateY(-5px) rotate(-3deg) scale(1.05); }
      80%     { transform: translateY(2px) rotate(2deg) scale(1.02); }
      90%     { transform: translateY(-3px) rotate(-2deg) scale(1.03); }
    }

    canvas{image-rendering:pixelated;}

    /* ===== SCENE 2: GALAXY (CSS) ===== */

    /* Canvas v≈© tr·ª• */
    #cv{
      position:fixed;
      inset:0;
      z-index:1;
      display:block;
      background:#000;
    }

    /* L·ªùi ch√∫c (tr√™n ƒë·∫ßu) */
    #wishBox{
      position:fixed;
      top:0;
      left:0;
      width:100%;
      padding:28px 16px;
      text-align:center;

      font-family: "Dancing Script", system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      font-size:clamp(24px,4vw,40px);
      line-height:1.35;
      color:#fff;

      text-shadow:
        0 0 12px rgba(255,100,200,1),
        0 0 28px rgba(255,0,120,0.8),
        0 4px 10px rgba(0,0,0,.8);

      background: linear-gradient(to bottom, rgba(0,0,0,.45), rgba(0,0,0,0));

      pointer-events:none;
      opacity:0;
      transition: opacity .8s ease;
      z-index:5;

      display:block;
    }

    @media (max-width: 480px){
      #wishBox{ transform: translateX(-3.5vw); }
    }
  </style>
</head>
<body>

  <!-- SCENE 1: BIRTHDAY -->
  <div id="scene-birthday">
    <div id="pinkBg"></div>
    <div class="bgLayerImg" id="bgLayerDynamic"></div>

    <canvas id="matrix"></canvas>
    <canvas id="fireworks"></canvas>
    <canvas id="cuteLayer"></canvas>

    <!-- ch·ªØ -->
    <div class="rainAllWrap">
      <div class="rainWrap line1" aria-hidden="true">
        <div class="rain">
          <span class="drop">C</span><span class="drop">H</span><span class="drop">√ö</span><span class="drop">C</span><span class="drop">&nbsp;</span>
          <span class="drop">M</span><span class="drop">·ª™</span><span class="drop">N</span><span class="drop">G</span><span class="drop">&nbsp;</span>
          <span class="drop">S</span><span class="drop">I</span><span class="drop">N</span><span class="drop">H</span><span class="drop">&nbsp;</span>
          <span class="drop">N</span><span class="drop">H</span><span class="drop">·∫¨</span><span class="drop">T</span><span class="drop">!</span>
        </div>
      </div>

      <div class="rainWrap line2" aria-hidden="true">
        <div class="rain">
          <span class="drop">B</span><span class="drop">·∫°</span><span class="drop">n</span><span class="drop">&nbsp;</span>
          <span class="drop">i</span><span class="drop">u</span>
        </div>
      </div>

      <div class="rainWrap line3" aria-hidden="true">
        <div class="rain">
          <span class="drop">2</span><span class="drop">9</span><span class="drop">+</span>
        </div>
      </div>
    </div>

    <!-- h·ªôp qu√† -->
    <div class="giftWrap" id="giftWrap">
      <div class="giftEmoji" id="giftEmoji">
        üéÅ
        <div class="giftText">M·ªü qu√†</div>
      </div>
    </div>
  </div>

  <!-- SCENE 2: GALAXY -->
  <div id="scene-galaxy" style="display:none;">
    <div id="wishBox"></div>
    <canvas id="cv"></canvas>
  </div>

  <!-- BGM CHUNG -->
  <audio id="bgm" preload="auto" loop playsinline style="display:none"></audio>

<script>
/* ===== KEYS d√πng chung ===== */
const LS_IMG_BIRTH_TOP  = 'img_birthday_top_dataurl';
const LS_GREETING       = 'greeting_text';

/* ===== BGM Player (d√πng chung cho c·∫£ 2 scene) ===== */
(async () => {
  const DEFAULT_BGM_URL = 'hpbd.mp3';
  const KEY_BGM = 'bgm_blob';
  const audio = document.getElementById('bgm');
  audio.volume = 0.4;

  function openDB(){
    return new Promise((resolve,reject)=>{
      const req = indexedDB.open('birthdayDB',1);
      req.onsuccess=()=>resolve(req.result);
      req.onupgradeneeded=()=>req.result.createObjectStore('images');
      req.onerror=()=>reject(req.error);
    });
  }
  async function dbGet(key){
    const db = await openDB();
    return new Promise((resolve,reject)=>{
      const tx=db.transaction('images','readonly');
      const req=tx.objectStore('images').get(key);
      req.onsuccess=()=>resolve(req.result||null);
      req.onerror=()=>reject(req.error);
    });
  }

  // ∆∞u ti√™n nh·∫°c user
  const blob = await dbGet(KEY_BGM);
  if(blob){
    const url = URL.createObjectURL(blob);
    audio.src = url;
  } else {
    audio.src = DEFAULT_BGM_URL;
  }

  // auto play (d·ª±a tr√™n pass t·ª´ index.html)
  const allowed = sessionStorage.getItem('allow_music')==='1';
  sessionStorage.removeItem('allow_music');

  const tryPlay = ()=>audio.play().catch(()=>{
    const kick = ()=>audio.play();
    window.addEventListener('pointerdown',kick,{once:true});
    window.addEventListener('keydown',kick,{once:true});
  });

  if(allowed) tryPlay();
})();
</script>

<script>
/* ===== BIRTHDAY: ƒë·ªïi n·ªÅn theo ·∫£nh user (birthday_top) ===== */
(function applyBirthdayTopBackground(){
  const KEY = LS_IMG_BIRTH_TOP;
  const bgLayer = document.getElementById('bgLayerDynamic');
  const topImg = localStorage.getItem(KEY);

  if (topImg) {
    bgLayer.style.background = `url("${topImg}") center / cover no-repeat fixed`;
    bgLayer.style.filter = 'none';

    const pink = document.getElementById('pinkBg');
    if (pink) pink.style.display = 'none';
    document.body.classList.add('no-pink-bg');
  }
})();

/* ===== BIRTHDAY: hi·ªáu ·ª©ng ch·ªØ r∆°i + hi·ªÉn th·ªã h·ªôp qu√† ===== */
function playLine(lineElem, callback){
  lineElem.classList.add('show');
  const letters = lineElem.querySelectorAll('.drop');
  letters.forEach((span, idx) => {
    const delay = 0.1 * (idx + 1);
    span.style.animationDelay = delay + 's';
    span.classList.add('animate');
  });
  const totalMs = (0.1 * letters.length + 1.8) * 1000;
  setTimeout(() => { if (callback) callback(); }, totalMs);
}

const line1 = document.querySelector('.rainWrap.line1');
const line2 = document.querySelector('.rainWrap.line2');
const line3 = document.querySelector('.rainWrap.line3');

const giftWrap = document.getElementById('giftWrap');

playLine(line1, () => {
  playLine(line2, () => {
    playLine(line3, () => {
      giftWrap.classList.add('show');
    });
  });
});

/* ===== BIRTHDAY: matrix text background ===== */
const cvsMatrix = document.getElementById('matrix');
const ctxM = cvsMatrix.getContext('2d');
const glyphs = 'HappyBirthdayüéÇ‚ú®';
let W,H,cols,drops,DPR_M;
function resizeMatrix(){
  DPR_M = Math.max(1, window.devicePixelRatio || 1);
  W = cvsMatrix.width = Math.floor(innerWidth * DPR_M);
  H = cvsMatrix.height = Math.floor(innerHeight * DPR_M);
  cvsMatrix.style.width = innerWidth + 'px';
  cvsMatrix.style.height = innerHeight + 'px';
  ctxM.setTransform(DPR_M,0,0,DPR_M,0,0);
  const step = 22;
  cols = Math.floor(innerWidth / step);
  drops = Array(cols).fill(0);
}
addEventListener('resize', resizeMatrix);
resizeMatrix();
(function drawMatrix(){
  requestAnimationFrame(drawMatrix);
  ctxM.clearRect(0,0,innerWidth,innerHeight);
  const step = 22;
  ctxM.font = 'bold 18px monospace';
  ctxM.globalCompositeOperation = 'source-over';
  for(let i=0;i<drops.length;i++){
    const ch = glyphs[Math.floor(Math.random()*glyphs.length)];
    const x = i*step;
    const y = drops[i]*step;
    ctxM.lineWidth = 3;
    ctxM.strokeStyle = 'rgba(255,255,255,0.8)';
    ctxM.strokeText(ch, x, y);
    ctxM.shadowColor = 'rgba(255,105,180,.8)';
    ctxM.shadowBlur = 12;
    ctxM.fillStyle = '#fff';
    ctxM.fillText(ch, x, y);
    ctxM.shadowBlur = 0;
    if (y > H && Math.random() > 0.97) { drops[i] = 0; } else { drops[i] += 0.5; }
  }
})();

/* ===== BIRTHDAY: ph√°o hoa ===== */
const fwCanvas = document.getElementById('fireworks');
const fwCtx = fwCanvas.getContext('2d');
let fwW, fwH, fireworks=[], particles=[];
function resizeFW(){ fwW = fwCanvas.width = innerWidth; fwH = fwCanvas.height = innerHeight; }
addEventListener('resize', resizeFW); resizeFW();

class Firework {
  constructor(){
    this.x=Math.random()*fwW; this.y=fwH;
    this.tx=Math.random()*fwW; this.ty=Math.random()*fwH*0.4+fwH*0.1;
    this.vx=(this.tx-this.x)/30; this.vy=(this.ty-this.y)/30; this.life=30;
    const rainbow=['#ff3366','#ff9933','#ffff33','#33ff66','#33ccff','#9966ff','#ff33cc'];
    this.color=rainbow[Math.floor(Math.random()*rainbow.length)];
  }
  update(){ this.x+=this.vx; this.y+=this.vy; this.life--; if(this.life<=0){ explode(this.x,this.y); return false;} return true; }
  draw(){ fwCtx.beginPath(); fwCtx.fillStyle=this.color; fwCtx.arc(this.x,this.y,2,0,Math.PI*2); fwCtx.fill(); }
}
class Particle {
  constructor(x,y){
    const angle=Math.random()*Math.PI*2; const speed=Math.random()*3+1;
    this.x=x; this.y=y; this.vx=Math.cos(angle)*speed; this.vy=Math.sin(angle)*speed;
    this.alpha=1; this.decay=Math.random()*0.02+0.015;
    const rainbow=['#ff3366','#ff9933','#ffff33','#33ff66','#33ccff','#9966ff','#ff33cc'];
    this.color=rainbow[Math.floor(Math.random()*rainbow.length)];
  }
  update(){ this.x+=this.vx; this.y+=this.vy; this.vy+=0.03; this.alpha-=this.decay; return this.alpha>0; }
  draw(){ fwCtx.globalAlpha=this.alpha; fwCtx.beginPath(); fwCtx.fillStyle=this.color; fwCtx.arc(this.x,this.y,2,0,Math.PI*2); fwCtx.fill(); fwCtx.globalAlpha=1; }
}
function explode(x,y){ for(let i=0;i<40;i++){ particles.push(new Particle(x,y)); } }
function loopFW(){
  requestAnimationFrame(loopFW);
  fwCtx.clearRect(0,0,fwW,fwH);
  if(Math.random()<0.08){ fireworks.push(new Firework()); }
  fireworks = fireworks.filter(fw=>{ const alive=fw.update(); fw.draw(); return alive; });
  particles = particles.filter(p=>{ const alive=p.update(); p.draw(); return alive; });
}
loopFW();

/* ===== BIRTHDAY: tuy·∫øt + tim ===== */
const cuteCanvas = document.getElementById('cuteLayer');
const cuteCtx = cuteCanvas.getContext('2d');
let cW, cH, snowflakes=[], critters=[];
const ENABLE_SNOW = true, ENABLE_CRITTERS = true;

function resizeCute(){ cW = cuteCanvas.width = innerWidth; cH = cuteCanvas.height = innerHeight; }
addEventListener('resize', resizeCute); resizeCute();

function initSnow(){
  snowflakes = [];
  for(let i=0;i<50;i++){
    snowflakes.push({ x:Math.random()*cW, y:Math.random()*cH, r:Math.random()*3+3, spdY:Math.random()*1+0.8, drift:(Math.random()*1-0.5) });
  }
}
function initCritters(){
  critters = [];
  const EMOJIS = ['üíñ','üíñ','üíñ','üíñ','üíñ','üíñ'];
  for(let i=0;i<6;i++){
    critters.push({ emoji:EMOJIS[i%EMOJIS.length], x:Math.random()*cW, y:Math.random()*cH,
      vx:(Math.random()<0.5?-1:1)*(1.5+Math.random()*1.5),
      vy:(Math.random()<0.5?-1:1)*(1.5+Math.random()*1.5),
      size:28+Math.random()*8 });
  }
}
if(ENABLE_SNOW) initSnow();
if(ENABLE_CRITTERS) initCritters();

function loopCute(){
  requestAnimationFrame(loopCute);
  cuteCtx.clearRect(0,0,cW,cH);

  if(ENABLE_SNOW){
    cuteCtx.fillStyle = "#fff";
    for(const f of snowflakes){
      f.y += f.spdY; f.x += f.drift;
      if(f.y > cH){ f.y = -10; f.x = Math.random()*cW; }
      cuteCtx.beginPath(); cuteCtx.globalAlpha = 0.9; cuteCtx.arc(f.x,f.y,f.r,0,Math.PI*2); cuteCtx.fill();
    }
    cuteCtx.globalAlpha = 1;
  }

  if(ENABLE_CRITTERS){
    for(const c of critters){
      c.x += c.vx; c.y += c.vy;
      if(c.x < 20){ c.x = 20; c.vx *= -1; }
      if(c.x > cW-20){ c.x = cW-20; c.vx *= -1; }
      if(c.y < 20){ c.y = 20; c.vy *= -1; }
      if(c.y > cH-20){ c.y = cH-20; c.vy *= -1; }

      cuteCtx.save();
      cuteCtx.translate(c.x, c.y);
      if(c.vx < 0){ cuteCtx.scale(-1,1); }
      cuteCtx.font = `${c.size}px "Segoe UI Emoji","Apple Color Emoji","Noto Color Emoji",sans-serif`;
      cuteCtx.textAlign = "center";
      cuteCtx.textBaseline = "middle";
      cuteCtx.fillText(c.emoji,0,0);
      cuteCtx.restore();
    }
  }
  cuteCtx.globalAlpha = 1;
}
loopCute();

/* ===== BIRTHDAY: click h·ªôp qu√† -> chuy·ªÉn sang scene GALAXY ===== */
(function(){
  const giftWrap  = document.getElementById('giftWrap');
  const giftEmoji = document.getElementById('giftEmoji');

  function goNext(){
    // L∆∞u l·ªùi ch√∫c qua galaxy
    const greet = localStorage.getItem(LS_GREETING)
      || "Ch√∫c m·ª´ng sinh nh·∫≠t üéÇ Ch√∫c b·∫°n lu√¥n xinh ƒë·∫πp, h·∫°nh ph√∫c v√† ƒë∆∞·ª£c y√™u th∆∞∆°ng nh·∫•t v≈© tr·ª• üíñ‚ú®";
    localStorage.setItem("wish_text", greet);

    // hi·ªáu ·ª©ng m·ªü n·∫Øp h·ªôp
    giftEmoji.classList.add('open');

    // ·∫®n scene birthday, hi·ªán galaxy
    setTimeout(()=>{
      const sceneBirthday = document.getElementById('scene-birthday');
      if (sceneBirthday) sceneBirthday.style.display = 'none';

      // N·ªÅn ƒëen cho galaxy
      document.body.style.background = '#000';

      const sceneGalaxy = document.getElementById('scene-galaxy');
      if (sceneGalaxy) sceneGalaxy.style.display = 'block';
    }, 600);
  }

  giftEmoji.addEventListener('click', goNext);
  giftWrap.addEventListener('click', goNext);
})();
</script>

<script>
/* =========================================================
   ========== GALAXY ORBIT (SCENE 2) =======================
   ========================================================= */

const wishEl = document.getElementById('wishBox');
const savedWish = localStorage.getItem('wish_text')
  || "Ch√∫c m·ª´ng sinh nh·∫≠t üéÇ Ch√∫c b·∫°n lu√¥n xinh ƒë·∫πp, h·∫°nh ph√∫c v√† ƒë∆∞·ª£c y√™u th∆∞∆°ng nh·∫•t v≈© tr·ª• üíñ‚ú®";
wishEl.textContent = savedWish;
setTimeout(()=> { wishEl.style.opacity = 1; }, 10000);

const cv = document.getElementById('cv');
const cx = cv.getContext('2d', { alpha: false });

let DPR = Math.min((window.devicePixelRatio||1), 1.75);
function resizeGalaxy(){
  cv.width  = Math.max(1, Math.floor(innerWidth  * DPR));
  cv.height = Math.max(1, Math.floor(innerHeight * DPR));
  cv.style.width  = innerWidth + 'px';
  cv.style.height = innerHeight + 'px';
  cx.setTransform(DPR,0,0,DPR,0,0);
}
addEventListener('resize', resizeGalaxy);
resizeGalaxy();

/* Perf preset */
const mem = navigator.deviceMemory || 4;
const LOW = mem <= 4 && innerWidth < 900;

const STAR_COUNT    = LOW ? 1200 : 2800;
const R_MAX         = 300;
const THICKNESS     = 22;
const ORBIT_SPRITES = 8;

/* camera-ish */
let autoSpeed = 0.0005;
let userRotY = 0.0;
let userRotX = 0.18;
const dist = 520;

/* Galaxy point cloud */
const points = [];
for (let i=0; i<STAR_COUNT; i++){
  const radius    = Math.pow(Math.random(), 0.55) * R_MAX;
  const arms      = 4;
  const baseAngle = Math.random() * Math.PI * 2;
  const twist     = radius * 0.17;
  const angle     = baseAngle
                  + Math.floor(Math.random()*arms) * (Math.PI*2/arms)
                  + twist;

  const y = (Math.random()-0.5) * THICKNESS;
  const x = Math.cos(angle) * radius;
  const z = Math.sin(angle) * radius;

  const hueBase = 200 + (angle/(Math.PI*2))*120;
  const sat     = 88;
  const light   = 55 + Math.random()*12;

  points.push({x,y,z,hueBase,sat,light});
}

/* Stars background */
const STAR_BOUND_X = 1300;
const STAR_BOUND_Y = 800;
const STAR_Z_NEAR  = 400;
const STAR_Z_FAR   = 2400;

const stars = Array.from({length: LOW ? 900 : 1400}, () => ({
  x: (Math.random()-0.5) * (STAR_BOUND_X*2),
  y: (Math.random()-0.5) * (STAR_BOUND_Y*2),
  z: Math.random() * (STAR_Z_FAR - STAR_Z_NEAR) + STAR_Z_NEAR,
  vx: (Math.random()-0.5) * 0.06,
  vy: (Math.random()-0.5) * 0.04,
  vz: (Math.random()-0.5) * 0.02
}));

/* Sprites (·∫£nh quay quanh) */
let spriteImgs = [];
let sprites    = [];

/* Drag input */
let dragging=false, px=0, py=0;

cv.addEventListener('mousedown', e=>{ dragging=true; px=e.clientX; py=e.clientY; });
addEventListener('mouseup', ()=> dragging=false);
addEventListener('mousemove', e=>{
  if(!dragging) return;
  const dx=e.clientX-px, dy=e.clientY-py;
  px=e.clientX; py=e.clientY;
  userRotY += dx*0.006;
  userRotX += dy*0.006;
  userRotX = Math.max(-1.2, Math.min(1.2, userRotX));
});

cv.addEventListener('touchstart', e=>{
  if(e.touches.length===1){
    dragging=true;
    px=e.touches[0].clientX;
    py=e.touches[0].clientY;
  }
},{passive:true});

cv.addEventListener('touchmove', e=>{
  if(e.touches.length===1 && dragging){
    const t0=e.touches[0];
    const dx=t0.clientX-px, dy=t0.clientY-py;
    px=t0.clientX; py=t0.clientY;
    userRotY+=dx*0.006;
    userRotX+=dy*0.006;
    userRotX=Math.max(-1.2,Math.min(1.2,userRotX));
  }
},{passive:true});

cv.addEventListener('touchend', ()=>{ dragging=false; },{passive:true});

/* 3D projection */
function proj(x,y,z){
  const cY = Math.cos(userRotY), sY = Math.sin(userRotY);
  const cX = Math.cos(userRotX), sX = Math.sin(userRotX);

  let X = x*cY - z*sY;
  let Z = x*sY + z*cY;
  let Y = y*cX - Z*sX;
  Z = y*sX + Z*cX + dist;

  const f = 450 / Z;
  return {
    x: innerWidth/2  + X*f,
    y: innerHeight/2 + Y*f,
    s: f
  };
}

/* Spotlight logic */
let mode = "orbit";
let tOrbit = 0;
let orbitFrameCounter = 0;
const ORBIT_FRAMES_BEFORE_SPOTLIGHT = 20;

let spotlightFrameCounter = 0;
const SPOTLIGHT_FRAMES = 60;

let spotlightSpriteIndex = 0;
let nextSpotlightSpriteIndex = 1;
let spotlightImageScale = 1;

let spotlightStartW = 100;
let spotlightZoom = 0;
function easeOutCubic(t){ return 1 - Math.pow(1 - t, 3); }

/* Rounded rect helper */
function roundRect(ctx, x, y, w, h, r){
  ctx.beginPath();
  ctx.moveTo(x+r, y);
  ctx.arcTo(x+w, y,   x+w, y+h, r);
  ctx.arcTo(x+w, y+h, x,   y+h, r);
  ctx.arcTo(x,   y+h, x,   y,   r);
  ctx.arcTo(x,   y,   x+w, y,   r);
  ctx.closePath();
}

/* Core glow */
let sortToggle = 0;
let pulsing = false;

function drawCoreGlow(){
  const cxMid = innerWidth/2;
  const cyMid = innerHeight/2;

  const g1 = cx.createRadialGradient(cxMid, cyMid, 0, cxMid, cyMid, innerWidth*0.35);
  g1.addColorStop(0, 'rgba(180,200,255,0.9)');
  g1.addColorStop(0.4,'rgba(140,100,255,0.6)');
  g1.addColorStop(0.7,'rgba(50,20,80,0.15)');
  g1.addColorStop(1, 'rgba(0,0,0,0)');
  cx.fillStyle = g1;
  cx.beginPath();
  cx.arc(cxMid, cyMid, innerWidth*0.4, 0, Math.PI*2);
  cx.fill();

  cx.save();
  cx.translate(cxMid, cyMid);
  cx.globalAlpha = 0.6;

  function starRay(angle, w, len){
    cx.save();
    cx.rotate(angle);
    const grd = cx.createLinearGradient(0,0,0,len);
    grd.addColorStop(0,'rgba(255,255,255,0.9)');
    grd.addColorStop(1,'rgba(255,255,255,0)');
    cx.fillStyle = grd;
    cx.beginPath();
    cx.moveTo(-w,0);
    cx.lineTo(w,0);
    cx.lineTo(0,len);
    cx.closePath();
    cx.fill();
    cx.restore();
  }

  const baseLen = Math.min(innerWidth,innerHeight)*0.28;
  const baseW   = baseLen*0.03;
  starRay(0,             baseW,     baseLen);
  starRay(Math.PI/2,     baseW,     baseLen);
  starRay(Math.PI/4,     baseW*0.7, baseLen*0.7);
  starRay(3*Math.PI/4,   baseW*0.7, baseLen*0.7);

  cx.restore();

  const g2 = cx.createRadialGradient(cxMid, cyMid, 0, cxMid, cyMid, 40);
  g2.addColorStop(0,'rgba(255,255,255,1)');
  g2.addColorStop(1,'rgba(255,255,255,0)');
  cx.fillStyle = g2;
  cx.beginPath();
  cx.arc(cxMid, cyMid, 40, 0, Math.PI*2);
  cx.fill();
}

/* draw card */
function drawCardImage(img, x, y, w, h, rr, border=false, scaleAlpha=1){
  cx.save();
  cx.translate(x, y);

  if (border) {
    cx.fillStyle = 'rgba(0,0,0,0.6)';
    roundRect(cx, -w/2, -h/2, w, h, rr);
    cx.fill();

    cx.lineWidth = Math.max(2, 4*scaleAlpha/3);
    cx.strokeStyle = 'rgba(255,120,200,0.6)';
    roundRect(cx, -w/2, -h/2, w, h, rr);
    cx.stroke();
  } else {
    cx.fillStyle = 'rgba(255,255,255,0.15)';
    roundRect(cx, -w/2, -h/2, w, h, rr);
    cx.fill();
  }

  if (img && img.complete && w>2 && h>2){
    cx.save();
    roundRect(cx, -w/2, -h/2, w, h, rr);
    cx.clip();
    cx.drawImage(img, -w/2, -h/2, w, h);
    cx.restore();
  }

  cx.restore();
}

/* Main render loop */
function renderLoop(){
  requestAnimationFrame(renderLoop);

  if (!spriteImgs.length || !sprites.length) {
    cx.fillStyle = "#000";
    cx.fillRect(0,0,innerWidth,innerHeight);
    return;
  }

  if (mode === "orbit"){
    tOrbit += 1;
    userRotY += autoSpeed;
    orbitFrameCounter++;

    if (orbitFrameCounter >= ORBIT_FRAMES_BEFORE_SPOTLIGHT){
      mode = "spotlight";
      orbitFrameCounter = 0;
      spotlightFrameCounter = 0;

      const curSlot = spotlightSpriteIndex % sprites.length;
      const sp = sprites[curSlot];

      const angNow = sp.baseA + tOrbit*(0.028 + sp.s*0.004);
      const px3 = Math.cos(angNow)*sp.r;
      const pz3 = Math.sin(angNow)*sp.r;
      const py3 = sp.y;
      const screen = proj(px3, py3, pz3);

      const startScale = sp.s * screen.s;
      spotlightStartW = 80 * startScale;
      spotlightZoom = 0;

      spotlightSpriteIndex = curSlot;
      nextSpotlightSpriteIndex = (curSlot + 1) % sprites.length;
    }

  } else if (mode === "spotlight"){
    spotlightFrameCounter++;
    if (spotlightFrameCounter >= SPOTLIGHT_FRAMES){
      mode = "orbit";
      spotlightSpriteIndex = nextSpotlightSpriteIndex;
    }
  }

  const gxMid = innerWidth*0.6;
  const gyMid = innerHeight*0.5;
  const gr = Math.max(innerWidth,innerHeight);
  const bg = cx.createRadialGradient(gxMid,gyMid,0,gxMid,gyMid,gr);
  bg.addColorStop(0,'rgba(20,30,60,0.55)');
  bg.addColorStop(0.6,'rgba(10,8,20,0.9)');
  bg.addColorStop(1,'rgba(0,0,0,1)');
  cx.fillStyle = bg;
  cx.fillRect(0,0,innerWidth,innerHeight);

  drawCoreGlow();

  for (const s of stars){
    s.x += s.vx;
    s.y += s.vy;
    s.z += s.vz;

    if (s.x < -STAR_BOUND_X) s.x =  STAR_BOUND_X;
    else if (s.x > STAR_BOUND_X) s.x = -STAR_BOUND_X;

    if (s.y < -STAR_BOUND_Y) s.y =  STAR_BOUND_Y;
    else if (s.y > STAR_BOUND_Y) s.y = -STAR_BOUND_Y;

    if (s.z < STAR_Z_NEAR) s.z = STAR_Z_FAR;
    else if (s.z > STAR_Z_FAR) s.z = STAR_Z_NEAR;

    const p2 = proj(s.x, s.y, s.z);
    const rStar = Math.max(0.4, 1.2 * p2.s);

    const sparkle = 0.65 + 0.35 * Math.sin((s.x + s.y + s.z + tOrbit*3) * 0.002);
    cx.globalAlpha = Math.min(1, Math.max(0.35, sparkle));

    cx.beginPath();
    cx.arc(p2.x, p2.y, rStar, 0, Math.PI*2);
    cx.fillStyle = '#ffffff';
    cx.fill();
  }
  cx.globalAlpha = 1;

  let drawList = points;
  if((sortToggle ^= 1)){
    drawList = points.slice().sort((a,b)=>{
      const za = a.x*Math.sin(userRotY)+a.z*Math.cos(userRotY);
      const zb = b.x*Math.sin(userRotY)+b.z*Math.cos(userRotY);
      return za - zb;
    });
  }
    const pulseAmt = pulsing ? (1 + Math.sin(tOrbit*0.06)*0.06) : 1;
  for(const p0 of drawList){
    // üéØ T√çNH L·∫†I X,Z THEO QU·ª∏ ƒê·∫†O QUAY
    const r       = Math.hypot(p0.x, p0.z);          // b√°n k√≠nh t·ª´ t√¢m
    const baseAng = Math.atan2(p0.z, p0.x);          // g√≥c ban ƒë·∫ßu
    const spinAng = baseAng + tOrbit * 0.01;         // t·ªëc ƒë·ªô quay (0.01: xoay ch·∫≠m, tƒÉng n·∫øu mu·ªën nhanh h∆°n)

    const spinX   = Math.cos(spinAng) * r;
    const spinZ   = Math.sin(spinAng) * r;

    const wobble = Math.sin((spinX + spinZ + tOrbit*0.8)*0.01)*0.5;
    const pr = proj(
      spinX * pulseAmt,
      (p0.y + wobble) * pulseAmt,
      spinZ * pulseAmt
    );

    const hue  = (p0.hueBase + 20*Math.sin(tOrbit*0.02)) % 360;
    const size = Math.min(2.8, 1.8*pr.s + 0.6);

    cx.fillStyle = `hsla(${hue}, ${p0.sat}%, ${p0.light}%, 0.9)`;
    cx.beginPath();
    cx.arc(pr.x, pr.y, size, 0, Math.PI*2);
    cx.fill();
  }

  if (mode === "spotlight"){
    cx.save();
    cx.fillStyle = 'rgba(0,0,0,0.4)';
    cx.fillRect(0,0,innerWidth,innerHeight);
    cx.restore();

    const slot = sprites[spotlightSpriteIndex];
    const img  = spriteImgs[slot.imgIndex % spriteImgs.length];

    const targetW = Math.min(innerWidth, innerHeight) * 0.5;
    spotlightZoom = Math.min(1, spotlightZoom + 0.08);
    const w = spotlightStartW + (targetW - spotlightStartW) * easeOutCubic(spotlightZoom);
    const h = w;
    const rr = Math.min(18, w/4);

    drawCardImage(img, innerWidth/2, innerHeight/2, w, h, rr, true, 1);

  } else {
    for (let i=0;i<sprites.length;i++){
      const sp = sprites[i];

      const angNow = sp.baseA + tOrbit*(0.028 + sp.s*0.004);
      const px3 = Math.cos(angNow)*sp.r;
      const pz3 = Math.sin(angNow)*sp.r;
      const py3 = sp.y;

      const screen = proj(px3, py3, pz3);

      const scaleNow = sp.s * screen.s;
      const baseCardSize = innerWidth < 500 ? 90 : 120;   // nh·ªè h∆°n tr√™n mobile
      const w = baseCardSize * scaleNow;
      const h = w;
      const rr = Math.min(10*scaleNow, w/4);

      const img = spriteImgs[sp.imgIndex % spriteImgs.length];

      drawCardImage(img, screen.x, screen.y, w, h, rr, false, scaleNow);
    }
  }
}

/* IndexedDB helpers cho galaxy */
const DB_NAME = 'birthdayDB';
const DB_VER  = 1;
const STORE   = 'images';

function openDBG() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = () => {
      const db = req.result;
      if (!db.objectStoreNames.contains(STORE)) {
        db.createObjectStore(STORE);
      }
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror   = () => reject(req.error);
  });
}

async function getImageFromDB(key) {
  const db = await openDBG();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE, 'readonly');
    const req = tx.objectStore(STORE).get(key);
    req.onsuccess = () => resolve(req.result || null);
    req.onerror   = () => reject(req.error);
  });
}

async function loadAllGalaxyImages() {
  const keys = [
    'img_galaxy_1',
    'img_galaxy_2',
    'img_galaxy_3',
    'img_galaxy_4',
    'img_galaxy_5'
  ];
  const out = [];
  for (const k of keys) {
    const blob = await getImageFromDB(k);
    if (blob) out.push(URL.createObjectURL(blob));
  }
  if (out.length === 0) {
    out.push('assets/cute-cake.png');
  }
  return out;
}

/* Kh·ªüi t·∫°o sprites sau khi load ·∫£nh */
async function initGalaxy() {
  const galaxyURLs = await loadAllGalaxyImages();
  spriteImgs = galaxyURLs.map(src => {
    const im = new Image();
    im.src = src;
    return im;
  });

  sprites = [];
  const baseR = (innerWidth < 500 ? 210 : 280);   // b√°n k√≠nh nh·ªè h∆°n tr√™n mobile
  for(let i=0;i<ORBIT_SPRITES;i++){
    const a = i / ORBIT_SPRITES * Math.PI*2;
    const r = baseR + Math.sin(i*0.7)*18;
    sprites.push({
      imgIndex: i % spriteImgs.length,
      baseA: a,
      r,
      y: (Math.random()-0.5)*30,
      s: 0.9 + Math.random()*0.4
    });
  }

  renderLoop();
}

initGalaxy();
</script>

</body>
</html>

